<div class="profile-container">
  <div class="profile-header">
  <h2>THÃ”NG TIN CHUNG</h2>
  <div>
    <a href="#" id="editBtn" class="edit-link"><i class="fa fa-pen"></i> Chá»‰nh sá»­a</a>
    <a href="#" id="changePasswordBtn" class="change-password-link"><i class="fa fa-lock"></i> Äá»•i máº­t kháº©u</a>
  </div>
</div>


  <form id="profileForm" class="profile-form">
    <div class="form-grid">
      <div class="form-group">
        <label>Há» vÃ  tÃªn</label>
        <input type="text" name="name" value="{{user.name}}" readonly />
      </div>
      <div class="form-group">
        <label>Username <span class="required">*</span></label>
        <input type="text" name="username" value="{{user.username}}" readonly />
      </div>

      <div class="form-group">
        <label>TÃªn rÃºt gá»n</label>
        <input type="text" name="shortName" value="{{user.shortName}}" readonly />
      </div>
      <div class="form-group">
        <label>Email <span class="required">*</span></label>
        <input type="email" name="email" value="{{user.email}}" readonly />
      </div>

      <div class="form-group">
        <label>Sá»‘ Ä‘iá»‡n thoáº¡i</label>
        <input type="text" name="phone" value="{{user.phone}}" readonly />
      </div>
      <div class="form-group">
        <label>NgÃ y sinh</label>
        <input type="date" name="birthDay" value="{{user.birthDay}}" readonly />
      </div>

      <div class="form-group">
        <label>Chá»©c danh <span class="required">*</span></label>
        <input type="text" name="position" value="{{user.position}}" readonly />
      </div>
      <div class="form-group">
        <label>ÄÆ¡n vá»‹ <span class="required">*</span></label>
        <input type="text" name="department" value="{{user.department}}" readonly />
      </div>

      <div class="form-group">
        <label>Role</label>
        <input type="text" name="role" value="{{user.role}}" readonly />
      </div>

      <div class="form-actions" style="display: none;">
        <button type="submit" class="btn btn-primary">ğŸ’¾ LÆ°u thay Ä‘á»•i</button>
        <button type="button" class="btn btn-secondary" id="cancelEditBtn">âœ–ï¸ Há»§y</button>
      </div>

    </div>
  

   
  </form>
</div>


<!-- Modal Ä‘á»•i máº­t kháº©u -->
<div id="changePasswordModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" id="closeChangePassword">&times;</span>
    <h3>ğŸ”’ Äá»•i máº­t kháº©u</h3>

    <form id="changePasswordForm">
      <label for="currentPassword">Máº­t kháº©u hiá»‡n táº¡i:</label>
      <input type="password" name="currentPassword" required>

      <label for="newPassword">Máº­t kháº©u má»›i:</label>
      <input type="password" name="newPassword" required>

      <label for="confirmPassword">XÃ¡c nháº­n máº­t kháº©u má»›i:</label>
      <input type="password" name="confirmPassword" required>

      <button type="submit" class="btn btn-primary">ğŸ’¾ LÆ°u máº­t kháº©u má»›i</button>
    </form>
  </div>
</div>


<script>
  const modal = document.getElementById('changePasswordModal');
  const modalContent = modal.querySelector('.modal-content');

  document.getElementById('changePasswordBtn').addEventListener('click', (e) => {
    e.preventDefault();
    modal.style.display = 'block';
  });

  document.getElementById('closeChangePassword').addEventListener('click', () => {
    modal.style.display = 'none';
  });

  // ÄÃ³ng modal khi click ngoÃ i modal-content
  modal.addEventListener('click', (e) => {
    if (!modalContent.contains(e.target)) {
      modal.style.display = 'none';
    }
  });

  document.getElementById('editBtn').addEventListener('click', function (e) {
    e.preventDefault();
    document.querySelectorAll('#profileForm input').forEach(input => {
      if (input.name !== 'username' && input.name !== 'role') {
        input.removeAttribute('readonly');
      }
    });
    document.querySelector('.form-actions').style.display = 'flex';
  });


  document.getElementById('cancelEditBtn').addEventListener('click', function () {
    window.location.reload();
  });


  document.getElementById('profileForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
      data[key] = value;
    });

    try {
      const res = await fetch('/auth/profile', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
          // Náº¿u dÃ¹ng JWT: thÃªm Authorization
          // 'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(data),
      });

      const result = await res.json();
      if (result.success) {
        showAlert('Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng','success');
        setTimeout(() => {
          window.location.reload();
        }, 1500);

      } else {
        showAlert(result.message || 'Cáº­p nháº­t tháº¥t báº¡i','danger');
      }
    } catch (err) {
      console.error('Lá»—i cáº­p nháº­t:', err);
      showAlert('Lá»—i khi gá»­i yÃªu cáº§u',error);
    }
  });


  document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const currentPassword = e.target.currentPassword.value;
    const newPassword = e.target.newPassword.value;
    const confirmPassword = e.target.confirmPassword.value;

    if (newPassword !== confirmPassword) {
      alert('âŒ Máº­t kháº©u má»›i khÃ´ng khá»›p');
      return;
    }

    try {
      const res = await fetch('/auth/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ currentPassword, newPassword }),
      });

      const data = await res.json();
      if (data.success) {
        alert('âœ… Äá»•i máº­t kháº©u thÃ nh cÃ´ng');
        modal.style.display = 'none';
      } else {
        alert('âŒ ' + (data.message || 'Lá»—i Ä‘á»•i máº­t kháº©u'));
      }
    } catch (err) {
      alert('âŒ Lá»—i khi gá»­i yÃªu cáº§u');
    }
  });

</script>
