<div class="profile-container">
    <div class="profile-header">
        <h2>TH√îNG TIN CHUNG</h2>
        <div>
            <a href="#" id="editBtn" class="edit-link">
                <i class="fa fa-pen"></i> Ch·ªânh s·ª≠a
            </a>
        </div>
    </div>

    <form id="profileForm" class="profile-form">
        <!-- Hidden field to hold user ID -->
        <input type="hidden" name="_id" value="{{selectedUser._id}}" />

        <div class="form-grid">
            <div class="form-group">
                <label>H·ªç v√† t√™n</label>
                <input type="text" name="name" value="{{selectedUser.name}}"
                    readonly />
            </div>
            <div class="form-group">
                <label>Username <span class="required">*</span></label>
                <input type="text" name="username"
                    value="{{selectedUser.username}}" readonly />
            </div>

            <div class="form-group">
                <label>T√™n r√∫t g·ªçn</label>
                <input type="text" name="shortName"
                    value="{{selectedUser.shortName}}" readonly />
            </div>
            <div class="form-group">
                <label>Email <span class="required">*</span></label>
                <input type="email" name="email" value="{{selectedUser.email}}"
                    readonly />
            </div>

            <div class="form-group">
                <label>S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="text" name="phone" value="{{selectedUser.phone}}"
                    readonly />
            </div>
            <div class="form-group">
                <label>Ng√†y sinh</label>
                <input type="date" name="birthDay"
                    value="{{selectedUser.birthDay}}" readonly />
            </div>

            <div class="form-group">
                <label>Ch·ª©c danh <span class="required">*</span></label>
                <input type="text" name="position"
                    value="{{selectedUser.position}}" readonly />
            </div>

            <div class="form-group">
                <label for="department">Ph√≤ng ban</label>
                <!-- Hi·ªÉn th·ªã input readonly khi kh√¥ng ch·ªânh s·ª≠a -->
                <input type="text" id="department_display"
                    value="{{selectedUser.department}}" readonly />

                <!-- Select ·∫©n, ch·ªâ hi·ªán khi edit -->
                <select id="department" name="department" style="display:none;">
                    <option value>-- Ch·ªçn ph√≤ng ban --</option>
                    <option value="Ph√≤ng V√¥ Tuy·∫øn">Ph√≤ng V√¥ Tuy·∫øn</option>
                    <option value="Ph√≤ng K·∫ø To√°n">Ph√≤ng K·∫ø To√°n</option>
                    <option value="Ph√≤ng H·∫° T·∫ßng">Ph√≤ng H·∫° T·∫ßng</option>
                    <option value="Ph√≤ng Truy·ªÅn D·∫´n">Ph√≤ng Truy·ªÅn D·∫´n</option>
                    <option value="Nh√≥m BO T·∫≠p Trung">Nh√≥m BO T·∫≠p Trung</option>
                    <option value="Ph√≤ng T·ªï ch·ª©c - H√†nh ch√≠nh">Ph√≤ng T·ªï ch·ª©c - H√†nh ch√≠nh</option>
                    <option value="Ph√≤ng K·∫ø ho·∫°ch - ƒê·∫ßu t∆∞">Ph√≤ng T·ªï Ch·ª©c - H√†nh ch√≠nh</option>
                </select>
            </div>

            <div class="form-group">
                <label>Role</label>
                <!-- Hi·ªÉn th·ªã input readonly khi kh√¥ng ch·ªânh s·ª≠a -->
                <input type="text" id="role_display"
                    value="{{selectedUser.role}}" readonly />

                <!-- Select ·∫©n, ch·ªâ hi·ªán khi edit -->
                <select id="role" name="role" style="display:none;" required>
                    <option value>-- Ch·ªçn vai tr√≤ --</option>
                    <!-- <option value="admin">Admin</option> -->
                    <option value="manager">manager</option>
                    <option value="view">view</option>
                </select>
            </div>

            <div class="form-actions" style="display: none;">
                <button type="submit" class="btn btn-primary">üíæ L∆∞u thay
                    ƒë·ªïi</button>
                <button type="button" class="btn btn-secondary"
                    id="cancelEditBtn">‚úñÔ∏è H·ªßy</button>
            </div>

            <div class="form-actions" style="display: none;">
                <button type="submit" class="btn btn-primary">üíæ L∆∞u thay
                    ƒë·ªïi</button>
                <button type="button" class="btn btn-secondary"
                    id="cancelEditBtn">‚úñÔ∏è H·ªßy</button>
            </div>
        </div>
    </form>
</div>

<script>
  document.getElementById('editBtn').addEventListener('click', function (e) {
  e.preventDefault();

  // B·ªè readonly t·∫•t c·∫£ input tr·ª´ _id
  document.querySelectorAll('#profileForm input').forEach(input => {
    if (input.name !== '_id') {
      input.removeAttribute('readonly');
    }
  });

  // ·∫®n input readonly v√† hi·ªán select t∆∞∆°ng ·ª©ng
  document.getElementById('department_display').style.display = 'none';
  document.getElementById('role_display').style.display = 'none';

  const departmentSelect = document.getElementById('department');
  const roleSelect = document.getElementById('role');

  departmentSelect.style.display = 'block';
  roleSelect.style.display = 'block';

  // Set gi√° tr·ªã select b·∫±ng gi√° tr·ªã input readonly ban ƒë·∫ßu
  departmentSelect.value = document.getElementById('department_display').value;
  roleSelect.value = document.getElementById('role_display').value;

  // Hi·ªán n√∫t l∆∞u/h·ªßy
  document.querySelector('.form-actions').style.display = 'flex';
});

document.getElementById('cancelEditBtn').addEventListener('click', function () {
  // ·∫®n select, hi·ªán l·∫°i input readonly
  document.getElementById('department_display').style.display = 'block';
  document.getElementById('role_display').style.display = 'block';

  document.getElementById('department').style.display = 'none';
  document.getElementById('role').style.display = 'none';

  // ·∫®n n√∫t l∆∞u/h·ªßy
  document.querySelector('.form-actions').style.display = 'none';

  // Reload trang ƒë·ªÉ tr·ªü v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
  window.location.reload();
});



  // G·ª≠i form c·∫≠p nh·∫≠t
  document.getElementById('profileForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
      data[key] = value;
    });

    const id = data._id;
    if (!id) {
      showAlert('Kh√¥ng t√¨m th·∫•y ID ng∆∞·ªùi d√πng', 'danger');
      return;
    }

    try {
      const res = await fetch(`/auth/user/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (result.success) {
        showAlert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng', 'success');
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showAlert(result.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i', 'danger');
      }
    } catch (err) {
      console.error('L·ªói c·∫≠p nh·∫≠t:', err);
      showAlert('L·ªói khi g·ª≠i y√™u c·∫ßu', 'danger');
    }
  });

  
</script>
