<div class="header-dashboard">
  <div class="title-dashboard">
    <h2>{{title}}</h2>
  </div>

  <div class="filter-group">
    <div class="filter-item">
      <label for="yearSelect">Năm:</label>
      <select id="yearSelect"></select>
    </div>
    <div class="filter-item">
      <label for="monthSelect">Tháng:</label>
      <select id="monthSelect">
        <option value="all">Tất cả tháng</option>
      </select>
    </div>
    <div class="filter-item">
      <label for="daySelect">Ngày:</label>
      <select id="daySelect">
        <option value="all">Tất cả ngày</option>
      </select>
    </div>
  </div>
</div>

<div class = "body-dashboard">

  <div class = "item-sum">

    {{!-- <div id="average-card" >
      <p>Đang tải...</p>
    </div> --}}

    <div  class="stat-card">
      <div class="stat-title">Thời gian MLL trung bình</div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>

    </div>

    <div  class="stat-card">
      <div class="stat-title">Thời gian MLL trung bình ngày</div>
      <div id="average-card-day" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card-day" ></div>
    </div>

    <div  class="stat-card">
      <div class="stat-title">Thời gian MLL trung bình đêm</div>
      <div id="average-card-night" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card-night" ></div>
    </div>

    <div  class="stat-card">
      <div class="stat-title">Avg TgMLL</div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>
   

  </div>


  <div class="item-deltail">

    <div class = "item-body">

    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

    <div  class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

    <div  class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

  </div>

  <div class = "item-body">
    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>
  </div>

  <div class = "item-body">
    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>

    <div class="stat-card">
      <div class="stat-title"></div>
      <div id="average-card" class="stat-value loader"></div>
      <div class="stat-footer" id="date-average-card" ></div>
    </div>
  </div>

</div>
  </div>



<script>
  let fullDayData = []; // Dữ liệu ngày để tạo slicer và dùng khi chọn ngày

  async function fetchDayData() {
    // Lấy dữ liệu ngày đầu tiên khi load
    const res = await fetch('/dashboard/average-duration?filterType=day');
    const json = await res.json();
    if (!json.success) {
      document.getElementById('average-card').innerHTML = '<p>Lỗi tải dữ liệu</p>';
      return;
    }
    fullDayData = json.data;

    // Khởi tạo slicer năm, tháng, ngày
    initSlicers(fullDayData);

    // Mặc định gọi API trung bình năm với năm gần nhất
    const latestYear = getLatestYear(fullDayData);
    fetchYearAverage(latestYear);
  }

  function initSlicers(data) {
    // Lấy danh sách năm từ dữ liệu ngày
    const yearSelect = document.getElementById('yearSelect');
    const years = [...new Set(data.map(d => d.PERIOD.split('/')[2]))].sort((a,b) => b - a);
    yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    yearSelect.value = years[0];

    updateMonths(years[0]);
    updateDays('all');

    // Gán event
    yearSelect.onchange = () => {
      updateMonths(yearSelect.value);
      updateDays('all');
      fetchYearAverage(yearSelect.value);
    };

    document.getElementById('monthSelect').onchange = (e) => {
      const month = e.target.value;
      updateDays(month);
      if (month === 'all') {
        fetchYearAverage(yearSelect.value);
      } else {
        fetchMonthAverage(yearSelect.value, month);
      }
    };

    document.getElementById('daySelect').onchange = (e) => {
      const day = e.target.value;
      if (day === 'all') {
        // Nếu chọn tất cả ngày, tùy theo chọn tháng
        const month = document.getElementById('monthSelect').value;
        if (month === 'all') {
          fetchYearAverage(yearSelect.value);
        } else {
          fetchMonthAverage(yearSelect.value, month);
        }
      } else {
        showDayAverage(day, document.getElementById('monthSelect').value, yearSelect.value);
      }
    };
  }

  function updateMonths(year) {
    const monthSelect = document.getElementById('monthSelect');
    const filtered = fullDayData.filter(d => d.PERIOD.endsWith(year));
    const months = [...new Set(filtered.map(d => d.PERIOD.split('/')[1]))].sort((a,b) => a - b);

    monthSelect.innerHTML = `<option value="all">Tất cả tháng</option>` +
      months.map(m => `<option value="${m}">${m}</option>`).join('');
    monthSelect.value = 'all';
  }

  function updateDays(month) {
    const daySelect = document.getElementById('daySelect');
    const year = document.getElementById('yearSelect').value;

    if (month === 'all') {
      daySelect.innerHTML = `<option value="all">Tất cả ngày</option>`;
      daySelect.value = 'all';
      return;
    }

    const filteredMonth = fullDayData.filter(d => d.PERIOD.endsWith(`${month}/${year}`));
    const days = [...new Set(filteredMonth.map(d => d.PERIOD.split('/')[0]))].sort((a,b) => a - b);

    daySelect.innerHTML = `<option value="all">Tất cả ngày</option>` +
      days.map(d => `<option value="${d}">${d}</option>`).join('');
    daySelect.value = 'all';
  }

  function getLatestYear(data) {
    return [...new Set(data.map(d => d.PERIOD.split('/')[2]))].sort((a,b) => b - a)[0];
  }

  // Hàm gọi API lấy trung bình năm
  async function fetchYearAverage(year) {
    const res = await fetch(`/dashboard/average-duration?filterType=year&year=${year}`);
    const json = await res.json();
    if (!json.success) return;

    const avg = json.data.length > 0 ? json.data[0].AVG_DURATION_TOTAL : 0;
    const avg_day = json.data.length > 0 ? json.data[0].AVG_DURATION_DAYTIME : 0;
    const avg_night = json.data.length > 0 ? json.data[0].AVG_DURATION_NIGHTTIME : 0;
    
    document.getElementById('average-card').classList.remove('loader');
    document.getElementById('average-card').innerHTML = `<div>${avg.toFixed(2)}</div>`;
    document.getElementById('date-average-card').innerHTML = `<div><strong>Năm ${year}</strong></div>`;

    document.getElementById('average-card-day').classList.remove('loader');
    document.getElementById('average-card-day').innerHTML = `<div>${avg_day.toFixed(2)}</div>`;
    document.getElementById('date-average-card-day').innerHTML = `<div><strong>Năm ${year}</strong></div>`;

    document.getElementById('average-card-night').classList.remove('loader');
    document.getElementById('average-card-night').innerHTML = `<div>${avg_night.toFixed(2)}</div>`;
    document.getElementById('date-average-card-night').innerHTML = `<div><strong>Năm ${year}</strong></div>`;
  }

  // Hàm gọi API lấy trung bình tháng
  async function fetchMonthAverage(year, month) {
    const res = await fetch(`/dashboard/average-duration?filterType=month&year=${year}&month=${month}`);
    const json = await res.json();
    if (!json.success) return;

    const avg = json.data.length > 0 ? json.data[0].AVG_DURATION_TOTAL : 0;
    const avg_day = json.data.length > 0 ? json.data[0].AVG_DURATION_DAYTIME : 0;
    const avg_night = json.data.length > 0 ? json.data[0].AVG_DURATION_NIGHTTIME : 0;

    document.getElementById('average-card').classList.remove('loader');
    document.getElementById('average-card').innerHTML = `<div>${avg.toFixed(2)}</div>`;
    document.getElementById('date-average-card').innerHTML = `<div><strong>Tháng ${month}/${year}</strong></div>`;

    document.getElementById('average-card-day').classList.remove('loader');
    document.getElementById('average-card-day').innerHTML = `<div>${avg_day.toFixed(2)}</div>`;
    document.getElementById('date-average-card-day').innerHTML = `<div><strong>Tháng ${month}/${year}</strong></div>`;

    document.getElementById('average-card-night').classList.remove('loader');
    document.getElementById('average-card-night').innerHTML = `<div>${avg_night.toFixed(2)}</div>`;
    document.getElementById('date-average-card-night').innerHTML = `<div><strong>Tháng ${month}/${year}</strong></div>`;
  }

  // Hiển thị trung bình ngày từ dữ liệu đã load fullDayData (không gọi API)
  function showDayAverage(day, month, year) {
    const periodStr = `${day}/${month}/${year}`;
    const dayData = fullDayData.find(d => d.PERIOD === periodStr);
    const avg = dayData ? dayData.AVG_DURATION_TOTAL : 0;
    const avg_day = dayData ? dayData.AVG_DURATION_DAYTIME : 0;
    const avg_night = dayData ? dayData.AVG_DURATION_NIGHTTIME : 0;

    document.getElementById('average-card').classList.remove('loader');
    document.getElementById('average-card').innerHTML = `<div>${avg.toFixed(2)}</div>`;
    document.getElementById('date-average-card').innerHTML = `<div><strong>Ngày ${periodStr}</strong></div>`;

    document.getElementById('average-card-day').classList.remove('loader');
    document.getElementById('average-card-day').innerHTML = `<div>${avg_day.toFixed(2)}</div>`;
    document.getElementById('date-average-card-day').innerHTML = `<div><strong>Ngày ${periodStr}</strong></div>`;

    document.getElementById('average-card-night').classList.remove('loader');
    document.getElementById('average-card-night').innerHTML = `<div>${avg_night.toFixed(2)}</div>`;
    document.getElementById('date-average-card-night').innerHTML = `<div><strong>Ngày ${periodStr}</strong></div>`;
  }

  // Khi load trang
  fetchDayData();

</script>
