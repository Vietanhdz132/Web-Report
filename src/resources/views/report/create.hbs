<div class="report-pvt-create">
  <h1 class="report-pvt-create__title">Táº¡o BÃ¡o CÃ¡o Tuáº§n Má»›i - PhÃ²ng VÃ´ Tuyáº¿n</h1>

  <form id="createReportForm" action="/report/create" method="POST" class="report-pvt-create__form">
    <!-- ThÃ´ng tin chung -->
    <div class="report-pvt-create__group">
    <label for="reportName">TÃªn bÃ¡o cÃ¡o</label>
    <input id="reportName" name="reportName" type="text" placeholder="Nháº­p tÃªn bÃ¡o cÃ¡o" required />
  </div>

  <div class="report-pvt-create__group">
    <label for="number">Sá»‘ hiá»‡u</label>
    <input id="number" name="number" type="text" required />
  </div>

  {{!-- <div class="report-pvt-create__group">
    <label for="receivers">KÃ­nh gá»­i</label>
    <textarea id="receivers" name="receivers" rows="3" placeholder="Nháº­p danh sÃ¡ch ngÆ°á»i nháº­n" required></textarea>
  </div> --}}

  <div class="report-pvt-create__group">
    <label for="createdAt">NgÃ y táº¡o</label>
    <input id="createdAt" name="createdAt" type="date" required />
  </div>


    <!-- I. ÄÃ¡nh giÃ¡ káº¿t quáº£ triá»ƒn khai -->
    <hr />
    <h2>I. ÄÃNH GIÃ Káº¾T QUáº¢ TRIá»‚N KHAI</h2>

    <div class="report-pvt-create__group" data-section="bscKpi">
      <h4>1. Káº¿t quáº£ thá»±c hiá»‡n BSC-KPI</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'bscKpi')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'bscKpi')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <h4>2. CÃ´ng viá»‡c trá»ng tÃ¢m</h4>

    <div class="report-pvt-create__group" data-section="tuh">
      <label for="tuh">CÃ´ng tÃ¡c TUH</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'tuh')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'tuh')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="ptm">
      <label for="ptm">CÃ´ng tÃ¡c PTM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'ptm')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'ptm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="cntt">
      <label for="cntt">CÃ´ng tÃ¡c CNTT</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'cntt')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'cntt')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="vhm">
      <label for="vhm">CÃ´ng tÃ¡c VHM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'vhm')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'vhm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="khcp">
      <label for="khcp">CÃ´ng tÃ¡c KHCP</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'khcp')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'khcp')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- II. Káº¿t luáº­n chá»‰ Ä‘áº¡o -->
    <hr />
    <h2>II. THá»°C HIá»†N Káº¾T LUáº¬N, CHá»ˆ Äáº O</h2>
    <div class="report-pvt-create__group" data-section="conclusion">
      <h4>Ná»™i dung káº¿t luáº­n, chá»‰ Ä‘áº¡o</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'conclusion')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'conclusion')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- III. Tá»“n táº¡i, kiáº¿n nghá»‹ -->
    <hr />
    <h2>III. Tá»’N Táº I, KIáº¾N NGHá»Š</h2>
    <div class="report-pvt-create__group" data-section="kientnghi_ldtt">
      <h4>1. Kiáº¿n nghá»‹ vá»›i LÄTT/TCT</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kientnghi_ldtt')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kientnghi_ldtt')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kientnghi_dvkhac">
      <h4>2. Kiáº¿n nghá»‹ vá»›i Ä‘Æ¡n vá»‹ khÃ¡c</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kientnghi_dvkhac')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kientnghi_dvkhac')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- IV. Káº¿ hoáº¡ch tuáº§n tá»›i -->
    <hr />
    <h2>IV. Káº¾ HOáº CH TUáº¦N Tá»šI</h2>

    <div class="report-pvt-create__group" data-section="kehoach_tuh">
      <label>CÃ´ng tÃ¡c TUH</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_tuh')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_tuh')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_ptm">
      <label>CÃ´ng tÃ¡c PTM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_ptm')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_ptm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_cntt">
      <label>CÃ´ng tÃ¡c CNTT</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_cntt')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_cntt')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_vhm">
      <label>CÃ´ng tÃ¡c VHM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_vhm')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_vhm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_khcp">
      <label>CÃ´ng tÃ¡c KHCP</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_khcp')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_khcp')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- NÆ¡i nháº­n -->
    <hr />
    <h2>NÆ I NHáº¬N</h2>
    <div class="report-pvt-create__group">
      <label for="receivers">NÆ¡i nháº­n</label>
      <textarea id="receivers" name="receivers" rows="4" required>- NhÆ° trÃªn;
- Ban GÄTT;
- Tá»•ng há»£p, TCHC;
- LÆ°u VTN.
      </textarea>
    </div>

    <!-- KÃ½ tÃªn -->
    <hr />
    <h2>ThÃ´ng tin kÃ½ bÃ¡o cÃ¡o</h2>
    <div class="report-pvt-create__group">
      <label for="signer">NgÆ°á»i kÃ½</label>
      <input id="signer" name="signer" type="text" value="Äá»— Duy BÃ¬nh" required />
    </div>
    <div class="report-pvt-create__group">
      <label for="position">Chá»©c vá»¥</label>
      <input id="position" name="position" type="text" value="TRÆ¯á»NG PHÃ’NG" required />
    </div>

    <div class="report-pvt-create__actions">
      <button type="submit">ğŸ’¾ LÆ°u bÃ¡o cÃ¡o</button>
      <a href="/report" class="btn-cancel">Há»§y</a>
    </div>
  </form>
</div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('createdAt').value = today;
  });
</script>


<script>
  // Tá»± Ä‘á»™ng resize textarea cho Ä‘áº¹p
  function autoResizeTextarea(el) {
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // ThÃªm má»¥c con (tiÃªu Ä‘á» + ná»™i dung + nÃºt xoÃ¡)
  function addChild(button, section) {
    const container = button.closest('.report-pvt-create__group').querySelector('.report-section__children');

    const wrapper = document.createElement('div');
    wrapper.className = 'report-subitem';
    wrapper.style.marginBottom = '10px';

    const title = document.createElement('textarea');
    title.placeholder = 'TiÃªu Ä‘á» má»¥c con';
    title.rows = 1;
    title.style.width = '100%';
    title.style.marginBottom = '6px';
    title.addEventListener('input', () => autoResizeTextarea(title));

    const content = document.createElement('textarea');
    content.placeholder = 'Ná»™i dung má»¥c con';
    content.rows = 3;
    content.style.width = '100%';
    content.style.marginBottom = '6px';
    content.addEventListener('input', () => autoResizeTextarea(content));

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'âŒ XoÃ¡ má»¥c con';
    removeBtn.onclick = () => wrapper.remove();

    wrapper.appendChild(title);
    wrapper.appendChild(content);
    wrapper.appendChild(removeBtn);

    container.appendChild(wrapper);
  }

  // ThÃªm báº£ng (tiÃªu Ä‘á» + báº£ng + nÃºt xoÃ¡)
  function addTable(button, section) {
    const container = button.closest('.report-pvt-create__group').querySelector('.report-section__children');

    const wrapper = document.createElement('div');
    wrapper.className = 'report-subtable';
    wrapper.style.marginBottom = '20px';

    // TiÃªu Ä‘á» báº£ng
    const title = document.createElement('textarea');
    title.placeholder = 'TiÃªu Ä‘á» báº£ng';
    title.rows = 1;
    title.style.width = '100%';
    title.style.resize = 'vertical';
    title.style.marginBottom = '10px';
    title.style.fontWeight = '600';
    title.addEventListener('input', () => autoResizeTextarea(title));
    autoResizeTextarea(title);

    // Cáº¥u hÃ¬nh báº£ng
    const config = document.createElement('div');
    config.style.display = 'flex';
    config.style.alignItems = 'center';
    config.style.gap = '10px';
    config.style.marginBottom = '10px';

    const rowsLabel = document.createElement('label');
    rowsLabel.textContent = 'Sá»‘ hÃ ng:';
    const rowsInput = document.createElement('input');
    rowsInput.type = 'number';
    rowsInput.min = 1;
    rowsInput.value = 3;
    rowsInput.style.width = '60px';
    rowsInput.style.marginLeft = '6px';
    rowsLabel.appendChild(rowsInput);

    const colsLabel = document.createElement('label');
    colsLabel.textContent = 'Sá»‘ cá»™t:';
    const colsInput = document.createElement('input');
    colsInput.type = 'number';
    colsInput.min = 1;
    colsInput.value = 3;
    colsInput.style.width = '60px';
    colsInput.style.marginLeft = '6px';
    colsLabel.style.marginLeft = '20px';
    colsLabel.appendChild(colsInput);

    const createBtn = document.createElement('button');
    createBtn.type = 'button';
    createBtn.textContent = 'Táº¡o báº£ng';
    createBtn.style.padding = '6px 12px';
    createBtn.style.cursor = 'pointer';
    createBtn.style.border = 'none';
    createBtn.style.borderRadius = '5px';
    createBtn.style.backgroundColor = '#0078d7';
    createBtn.style.color = 'white';
    createBtn.style.fontWeight = '600';

    createBtn.onmouseenter = () => createBtn.style.backgroundColor = '#005ea8';
    createBtn.onmouseleave = () => createBtn.style.backgroundColor = '#0078d7';

    config.appendChild(rowsLabel);
    config.appendChild(colsLabel);
    config.appendChild(createBtn);

    // Báº£ng
    const table = document.createElement('table');
    table.className = 'editable-table';
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';

    function createTable(rows, cols) {
      table.innerHTML = '';

      for (let r = 0; r < rows; r++) {
        const tr = document.createElement('tr');

        for (let c = 0; c < cols; c++) {
          const td = document.createElement('td');
          td.style.border = '1px solid #ccc';
          td.style.padding = '4px';

          const textarea = document.createElement('textarea');
          textarea.name = `tableSections[${section}][${wrapper.dataset.tableIndex || 0}][cells][]`;
          textarea.rows = 1;
          textarea.style.width = '100%';
          textarea.style.boxSizing = 'border-box';
          textarea.style.resize = 'vertical';
          textarea.style.fontFamily = 'inherit';

          // ğŸ’¡ Náº¿u lÃ  hÃ ng Ä‘áº§u tiÃªn thÃ¬ style Ä‘áº­m, ná»n xÃ¡m nháº¡t
          if (r === 0) {
            textarea.placeholder = `TiÃªu Ä‘á» cá»™t ${c + 1}`;
            textarea.style.fontWeight = 'bold';
            textarea.style.backgroundColor = '#f0f0f0';
          }

          textarea.addEventListener('input', () => autoResizeTextarea(textarea));
          autoResizeTextarea(textarea);

          td.appendChild(textarea);
          tr.appendChild(td);
        }

        table.appendChild(tr);
      }
    }


    createTable(3, 3);

    createBtn.onclick = () => {
      const rows = parseInt(rowsInput.value);
      const cols = parseInt(colsInput.value);
      if (rows > 0 && cols > 0) {
        createTable(rows, cols);
      } else {
        alert('Sá»‘ hÃ ng vÃ  sá»‘ cá»™t pháº£i lá»›n hÆ¡n 0');
      }
    };

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'âŒ XoÃ¡ báº£ng';
    removeBtn.style.marginTop = '10px';
    removeBtn.style.backgroundColor = '#e04545';
    removeBtn.style.color = '#fff';
    removeBtn.style.border = 'none';
    removeBtn.style.padding = '6px 12px';
    removeBtn.style.borderRadius = '5px';
    removeBtn.style.cursor = 'pointer';
    removeBtn.style.fontWeight = '600';

    removeBtn.onmouseenter = () => removeBtn.style.backgroundColor = '#a82727';
    removeBtn.onmouseleave = () => removeBtn.style.backgroundColor = '#e04545';
    removeBtn.onclick = () => wrapper.remove();

    wrapper.appendChild(title);
    wrapper.appendChild(config);
    wrapper.appendChild(table);
    wrapper.appendChild(removeBtn);

    container.appendChild(wrapper);
  }

  // âœ… Thu tháº­p dá»¯ liá»‡u cho má»—i section, giá»¯ nguyÃªn thá»© tá»±: má»¥c con vÃ  báº£ng
  function collectSectionData(section) {
    const group = document.querySelector(`[data-section="${section}"]`);
    if (!group) return [];

    const container = group.querySelector('.report-section__children');
    const results = [];

    if (!container) return results;

    Array.from(container.children).forEach(child => {
      if (child.classList.contains('report-subitem')) {
        const textareas = child.querySelectorAll('textarea');
        const title = textareas[0]?.value.trim() || '';
        const content = textareas[1]?.value.trim() || '';
        results.push({ type: 'text', title, content });
      } else if (child.classList.contains('report-subtable')) {
        const title = child.querySelector('textarea')?.value.trim() || '';
        const tableEl = child.querySelector('table');
        const rows = tableEl?.rows || [];

        const cells = [];
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const rowData = [];
          for (let j = 0; j < row.cells.length; j++) {
            const textarea = row.cells[j].querySelector('textarea');
            rowData.push(textarea ? textarea.value.trim() : '');
          }
          cells.push(rowData);
        }

        results.push({ type: 'table', title, cells });
      }
    });

    return results;
  }

  // Gá»­i dá»¯ liá»‡u
  document.getElementById('createReportForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const form = e.target;
    const data = {
      reportName: form.reportName.value,
      number: form.number.value,
      createdAt: form.createdAt.value,
      receivers: form.receivers.value,
      signer: form.signer.value,
      position: form.position.value,
      sections: {}
    };

    const sectionKeys = ['bscKpi', 'tuh', 'ptm', 'cntt', 'vhm', 'khcp', 'conclusion', 'kientnghi_ldtt', 'kientnghi_dvkhac', 'kehoach_tuh', 'kehoach_ptm', 'kehoach_cntt', 'kehoach_vhm', 'kehoach_khcp'];

    sectionKeys.forEach(section => {
      data.sections[section] = collectSectionData(section);
    });

    console.log('Dá»¯ liá»‡u gá»­i lÃªn:', data);

    fetch('/report/pvt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    }).then(res => res.json())
      .then(result => {
        if (result.success) alert('LÆ°u bÃ¡o cÃ¡o thÃ nh cÃ´ng!');
        else alert('Lá»—i lÆ°u bÃ¡o cÃ¡o');
      }).catch(() => alert('Lá»—i káº¿t ná»‘i server'));
  });
</script>
