<div class="report-pvt-create">
  <h1 class="report-pvt-create__title">Táº¡o BÃ¡o CÃ¡o Tuáº§n Má»›i - PhÃ²ng VÃ´ Tuyáº¿n</h1>

  <form id="createReportForm" action="/report/create" method="POST" class="report-pvt-create__form">
    <!-- ThÃ´ng tin chung -->
    <div class="report-pvt-create__group">
      <label for="reportName">TÃªn bÃ¡o cÃ¡o</label>
      <input id="reportName" name="reportName" type="text" placeholder="VD: BÃO CÃO TUáº¦N 1" required />
    </div>

    <div class="report-pvt-create__group">
      <label for="recipient">KÃ­nh gá»­i</label>
      <input id="recipient" name="recipient" type="text" placeholder="VD: GiÃ¡m Ä‘á»‘c Trung tÃ¢m Máº¡ng lÆ°á»›i MobiFone miá»n Báº¯c " required />
    </div>


  <div class="report-pvt-create__group">
    <label for="number">Sá»‘ hiá»‡u</label>
    <input id="number" name="number" type="text" placeholder="VD: 25">
  </div>

  {{!-- <div class="report-pvt-create__group">
    <label for="receivers">KÃ­nh gá»­i</label>
    <textarea id="receivers" name="receivers" rows="3" placeholder="Nháº­p danh sÃ¡ch ngÆ°á»i nháº­n" required></textarea>
  </div> --}}

  <div class="report-pvt-create__group">
    <label for="createdAt">NgÃ y táº¡o</label>
    <input id="createdAt" name="createdAt" type="date" required />
  </div>


    <!-- I. ÄÃ¡nh giÃ¡ káº¿t quáº£ triá»ƒn khai -->
    <hr />
    <h2>I. ÄÃNH GIÃ Káº¾T QUáº¢ TRIá»‚N KHAI</h2>

    <div class="report-pvt-create__group" data-section="bscKpi">
      <h4>1. Káº¿t quáº£ thá»±c hiá»‡n BSC-KPI</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'bscKpi')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'bscKpi')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <h4>2. CÃ´ng viá»‡c trá»ng tÃ¢m</h4>

    <div class="report-pvt-create__group" data-section="tuh">
      <label for="tuh">CÃ´ng tÃ¡c TUH</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'tuh')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'tuh')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="ptm">
      <label for="ptm">CÃ´ng tÃ¡c PTM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'ptm')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'ptm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="cntt">
      <label for="cntt">CÃ´ng tÃ¡c CNTT</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'cntt')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'cntt')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="vhm">
      <label for="vhm">CÃ´ng tÃ¡c VHM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'vhm')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'vhm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="khcp">
      <label for="khcp">CÃ´ng tÃ¡c KHCP</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'khcp')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'khcp')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- II. Káº¿t luáº­n chá»‰ Ä‘áº¡o -->
    <hr />
    <h2>II. THá»°C HIá»†N Káº¾T LUáº¬N, CHá»ˆ Äáº O</h2>
    <div class="report-pvt-create__group" data-section="conclusion">
      <h4>Ná»™i dung káº¿t luáº­n, chá»‰ Ä‘áº¡o</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'conclusion')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'conclusion')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- III. Tá»“n táº¡i, kiáº¿n nghá»‹ -->
    <hr />
    <h2>III. Tá»’N Táº I, KIáº¾N NGHá»Š</h2>
    <div class="report-pvt-create__group" data-section="kientnghi_ldtt">
      <h4>1. Kiáº¿n nghá»‹ vá»›i LÄTT/TCT</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kientnghi_ldtt')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kientnghi_ldtt')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kientnghi_dvkhac">
      <h4>2. Kiáº¿n nghá»‹ vá»›i Ä‘Æ¡n vá»‹ khÃ¡c</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kientnghi_dvkhac')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kientnghi_dvkhac')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- IV. Káº¿ hoáº¡ch tuáº§n tá»›i -->
    <hr />
    <h2>IV. Káº¾ HOáº CH TUáº¦N Tá»šI</h2>

    <div class="report-pvt-create__group" data-section="kehoach_tuh">
      <label>CÃ´ng tÃ¡c TUH</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_tuh')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_tuh')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_ptm">
      <label>CÃ´ng tÃ¡c PTM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_ptm')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_ptm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_cntt">
      <label>CÃ´ng tÃ¡c CNTT</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_cntt')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_cntt')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_vhm">
      <label>CÃ´ng tÃ¡c VHM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_vhm')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_vhm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_khcp">
      <label>CÃ´ng tÃ¡c KHCP</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem" onclick="addChild(this, 'kehoach_khcp')">â• ThÃªm má»¥c con</button>
        <button type="button" class="btn-add-table" onclick="addTable(this, 'kehoach_khcp')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- NÆ¡i nháº­n -->
    <hr />
    <h2>NÆ I NHáº¬N</h2>
    <div class="report-pvt-create__group">
      <label for="receivers">NÆ¡i nháº­n</label>
      <textarea id="receivers" name="receivers" rows="4" required>- NhÆ° trÃªn;
- Ban GÄTT;
- Tá»•ng há»£p, TCHC;
- LÆ°u VTN.
      </textarea>
    </div>

    <!-- KÃ½ tÃªn -->
    <hr />
    <h2>ThÃ´ng tin kÃ½ bÃ¡o cÃ¡o</h2>
    <div class="report-pvt-create__group">
      <label for="signer">NgÆ°á»i kÃ½</label>
      <input id="signer" name="signer" type="text" value="Äá»— Duy BÃ¬nh" required />
    </div>
    <div class="report-pvt-create__group">
      <label for="position">Chá»©c vá»¥</label>
      <input id="position" name="position" type="text" value="TRÆ¯á»NG PHÃ’NG" required />
    </div>

    <div class="report-pvt-create__actions">
      <button  type="submit">ğŸ’¾ LÆ°u bÃ¡o cÃ¡o</button>
      <a href="/report" class="btn-cancel">Há»§y</a>
    </div>
  </form>
</div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('createdAt').value = today;
  });
</script>


<script>
  
  function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto';        // reset chiá»u cao
  textarea.style.height = textarea.scrollHeight + 'px'; // Ä‘áº·t láº¡i theo ná»™i dung
}


// ThÃªm má»¥c con (chá»‰ cÃ³ 1 cáº¥p con thÃ´i, khÃ´ng lá»“ng tiáº¿p)
function addChild(button, section, containerOverride) {
  const container = containerOverride || button.closest('.report-pvt-create__group').querySelector('.report-section__children');

  const wrapper = document.createElement('div');
  wrapper.className = 'report-subitem';
  wrapper.style.marginBottom = '10px';
  wrapper.style.border = '1px solid #ccc';
  wrapper.style.padding = '10px';
  wrapper.style.borderRadius = '8px';
  wrapper.style.borderLeft = '3px dashed #aaa';
  wrapper.style.backgroundColor = '#fafafa';

  // TiÃªu Ä‘á» má»¥c con
  const title = document.createElement('textarea');
  title.placeholder = 'TiÃªu Ä‘á» má»¥c con';
  title.rows = 1;
  title.style.width = '100%';
  title.style.marginBottom = '6px';
  title.addEventListener('input', () => autoResizeTextarea(title));
  autoResizeTextarea(title);

  // VÃ¹ng chá»©a ná»™i dung phá»¥ vÃ  báº£ng
  const itemsContainer = document.createElement('div');
  itemsContainer.className = 'report-section__children';
  itemsContainer.style.marginTop = '10px';
  itemsContainer.style.borderLeft = '2px dashed #aaa';
  itemsContainer.style.paddingLeft = '10px';
  itemsContainer.style.backgroundColor = '#fafafa';

  // NhÃ³m nÃºt á»Ÿ dÆ°á»›i cÃ¹ng (3 nÃºt cÃ¹ng hÃ ng)
  const buttonGroup = document.createElement('div');
    buttonGroup.style.display = 'flex';
    buttonGroup.style.justifyContent = 'space-between';
    buttonGroup.style.gap = '10px';
    buttonGroup.style.marginTop = '10px';
    buttonGroup.style.marginLeft = '0'; 

  // NÃºt XoÃ¡ má»¥c con
  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.textContent = 'âŒ XoÃ¡ má»¥c con';
  removeBtn.onclick = () => wrapper.remove();

  // NÃºt ThÃªm báº£ng (mÃ u xanh)
  const addTableBtn = document.createElement('button');
  addTableBtn.type = 'button';
  addTableBtn.textContent = 'ğŸ“Š ThÃªm báº£ng';
  addTableBtn.style.backgroundColor = '#007acc';
  addTableBtn.style.color = '#fff';
  addTableBtn.style.border = 'none';
  addTableBtn.style.padding = '6px 12px';
  addTableBtn.style.borderRadius = '5px';
  addTableBtn.style.cursor = 'pointer';
  addTableBtn.style.fontWeight = '600';
 
  addTableBtn.onclick = () => addTable(addTableBtn, section, itemsContainer);

  // NÃºt ThÃªm ná»™i dung (mÃ u xanh)
  const addExtraBtn = document.createElement('button');
  addExtraBtn.type = 'button';
  addExtraBtn.textContent = 'â• ThÃªm ná»™i dung';
  addExtraBtn.style.backgroundColor = '#007acc';
  addExtraBtn.style.color = '#fff';
  addExtraBtn.style.border = 'none';
  addExtraBtn.style.padding = '6px 12px';
  addExtraBtn.style.borderRadius = '5px';
  addExtraBtn.style.cursor = 'pointer';
  addExtraBtn.style.fontWeight = '600';
  addExtraBtn.onmouseenter = () => (addExtraBtn.style.backgroundColor = '#005fa3');
  addExtraBtn.onmouseleave = () => (addExtraBtn.style.backgroundColor = '#007acc');
  addExtraBtn.onclick = () => addExtraContent(addExtraBtn, itemsContainer);

  // Gá»™p 3 nÃºt vÃ o nhÃ³m
  buttonGroup.appendChild(removeBtn);
  buttonGroup.appendChild(addTableBtn);
  buttonGroup.appendChild(addExtraBtn);
  // Gá»™p vÃ o nhÃ³m
  buttonGroup.appendChild(addExtraBtn);
  buttonGroup.appendChild(addTableBtn);

  buttonGroup.appendChild(removeBtn);

  // Gá»™p vÃ o wrapper theo thá»© tá»±
  wrapper.appendChild(title);
  wrapper.appendChild(itemsContainer);
  wrapper.appendChild(buttonGroup);

  container.appendChild(wrapper);
}


function addTable(button, section, containerOverride, level = 1) {
  const container = containerOverride || button.closest('.report-pvt-create__group').querySelector('.report-section__children');

  const wrapper = document.createElement('div');
  wrapper.className = 'report-subtable';
  wrapper.style.backgroundColor = '#fafafa';
  wrapper.style.padding = '10px';
  wrapper.style.marginBottom = '10px';
  wrapper.style.marginLeft = `${level * 20}px`;

  const title = document.createElement('textarea');
  title.placeholder = 'TiÃªu Ä‘á» báº£ng';
  title.rows = 1;
  title.style.width = '100%';
  title.style.resize = 'vertical';
  title.style.marginBottom = '10px';
  title.style.fontWeight = '600';
  title.addEventListener('input', () => autoResizeTextarea(title));
  autoResizeTextarea(title);

  const config = document.createElement('div');
  config.style.display = 'flex';
  config.style.alignItems = 'center';
  config.style.gap = '10px';
  config.style.marginBottom = '10px';

  const rowsLabel = document.createElement('label');
  rowsLabel.textContent = 'Sá»‘ hÃ ng:';
  const rowsInput = document.createElement('input');
  rowsInput.type = 'number';
  rowsInput.min = 1;
  rowsInput.value = 3;
  rowsInput.style.width = '60px';
  rowsInput.style.marginLeft = '6px';
  rowsLabel.appendChild(rowsInput);

  const colsLabel = document.createElement('label');
  colsLabel.textContent = 'Sá»‘ cá»™t:';
  const colsInput = document.createElement('input');
  colsInput.type = 'number';
  colsInput.min = 1;
  colsInput.value = 3;
  colsInput.style.width = '60px';
  colsInput.style.marginLeft = '6px';
  colsLabel.style.marginLeft = '20px';
  colsLabel.appendChild(colsInput);

  const createBtn = document.createElement('button');
  createBtn.type = 'button';
  createBtn.textContent = 'Táº¡o báº£ng';
  Object.assign(createBtn.style, {
    padding: '6px 12px',
    cursor: 'pointer',
    border: 'none',
    borderRadius: '5px',
    backgroundColor: '#0078d7',
    color: 'white',
    fontWeight: '600'
  });

  const selectBtn = document.createElement('button');
  selectBtn.type = 'button';
  selectBtn.textContent = 'Chá»n Ã´ cáº§n gá»™p';
  Object.assign(selectBtn.style, {
    padding: '6px 12px',
    cursor: 'pointer',
    border: 'none',
    borderRadius: '5px',
    backgroundColor: '#ffc107',
    color: '#000',
    fontWeight: '600',
  });

  const confirmMergeBtn = document.createElement('button');
  confirmMergeBtn.type = 'button';
  confirmMergeBtn.textContent = 'Gá»™p cÃ¡c Ã´ Ä‘Ã£ chá»n';
  confirmMergeBtn.style.display = 'none';
  Object.assign(confirmMergeBtn.style, {
    padding: '6px 12px',
    cursor: 'pointer',
    border: 'none',
    borderRadius: '5px',
    backgroundColor: '#28a745',
    color: 'white',
    fontWeight: '600'
  });

  const cancelMergeBtn = document.createElement('button');
  cancelMergeBtn.type = 'button';
  cancelMergeBtn.textContent = 'Huá»·';
  cancelMergeBtn.style.display = 'none';
  Object.assign(cancelMergeBtn.style, {
    padding: '6px 12px',
    cursor: 'pointer',
    border: 'none',
    borderRadius: '5px',
    backgroundColor: '#dc3545',
    color: 'white',
    fontWeight: '600'
  });

  config.appendChild(rowsLabel);
  config.appendChild(colsLabel);
  config.appendChild(createBtn);
  config.appendChild(selectBtn);
  config.appendChild(confirmMergeBtn);
  config.appendChild(cancelMergeBtn);

  const table = document.createElement('table');
  table.className = 'editable-table';
  Object.assign(table.style, {
    width: '100%',
    borderCollapse: 'collapse',
    marginTop: '10px'
  });

  function syncRowHeight(tr) {
    let maxHeight = 0;
    const textareas = tr.querySelectorAll('textarea');
    textareas.forEach(ta => {
      ta.style.height = 'auto';
      const h = ta.scrollHeight;
      if (h > maxHeight) maxHeight = h;
    });
    textareas.forEach(ta => {
      ta.style.height = maxHeight + 'px';
    });
  }

  function createTable(rows, cols) {
    table.innerHTML = '';
    for (let r = 0; r < rows; r++) {
      const tr = document.createElement('tr');
      for (let c = 0; c < cols; c++) {
        const td = document.createElement('td');
        td.style.border = '1px solid #ccc';
        td.style.padding = '4px';

        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'table-cell-wrapper';
        wrapperDiv.style.position = 'relative';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'table-cell-checkbox';
        checkbox.style.position = 'absolute';
        checkbox.style.top = '2px';
        checkbox.style.left = '2px';
        checkbox.style.zIndex = '1';
        checkbox.style.display = 'none';

        const textarea = document.createElement('textarea');
        textarea.rows = 1;
        textarea.style.width = '100%';
        textarea.style.boxSizing = 'border-box';
        textarea.style.resize = 'vertical';
        textarea.style.fontFamily = 'inherit';

        if (r === 0) {
          textarea.placeholder = `TiÃªu Ä‘á» cá»™t ${c + 1}`;
          textarea.style.fontWeight = 'bold';
          textarea.style.backgroundColor = '#f0f0f0';
        }

        textarea.addEventListener('input', () => {
          autoResizeTextarea(textarea);
          syncRowHeight(tr);
        });

        autoResizeTextarea(textarea);

        wrapperDiv.appendChild(checkbox);
        wrapperDiv.appendChild(textarea);
        td.appendChild(wrapperDiv);
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
  }

  createBtn.onclick = () => {
    const rows = parseInt(rowsInput.value);
    const cols = parseInt(colsInput.value);
    if (rows > 0 && cols > 0) {
      createTable(rows, cols);
    } else {
      alert('Sá»‘ hÃ ng vÃ  sá»‘ cá»™t pháº£i lá»›n hÆ¡n 0');
    }
  };

  let isSelecting = false;

  selectBtn.onclick = () => {
    isSelecting = true;
    selectBtn.style.display = 'none';
    confirmMergeBtn.style.display = 'inline-block';
    cancelMergeBtn.style.display = 'inline-block';

    const checkboxes = table.querySelectorAll('.table-cell-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = false;
      cb.style.display = 'block';
    });
  };

  cancelMergeBtn.onclick = () => {
    isSelecting = false;
    selectBtn.style.display = 'inline-block';
    confirmMergeBtn.style.display = 'none';
    cancelMergeBtn.style.display = 'none';

    const checkboxes = table.querySelectorAll('.table-cell-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = false;
      cb.style.display = 'none';
    });
  };

  // HÃ m tÃ­nh vá»‹ trÃ­ cá»™t "áº£o" dá»±a trÃªn colSpan cá»§a cÃ¡c Ã´ trong 1 hÃ ng
  function getCellsPositionsInRow(row) {
    const positions = [];
    let colPos = 0;
    for (const cell of row.cells) {
      positions.push({ cell, startCol: colPos, colSpan: cell.colSpan || 1 });
      colPos += cell.colSpan || 1;
    }
    return positions;
  }

  // HÃ m kiá»ƒm tra cÃ¡c Ã´ cÃ³ liá»n ká» trong 1 hÃ ng khÃ´ng
  function areCellsContiguousInRow(row, selectedCells) {
    const positions = getCellsPositionsInRow(row);

    const selectedPositions = positions.filter(p => selectedCells.includes(p.cell));

    // Sáº¯p xáº¿p theo vá»‹ trÃ­ cá»™t áº£o
    selectedPositions.sort((a, b) => a.startCol - b.startCol);

    for (let i = 1; i < selectedPositions.length; i++) {
      const prev = selectedPositions[i - 1];
      const curr = selectedPositions[i];
      if (prev.startCol + prev.colSpan !== curr.startCol) {
        return false;
      }
    }
    return true;
  }

  // HÃ m tÃ­nh vá»‹ trÃ­ hÃ ng "áº£o" dá»±a trÃªn rowSpan cá»§a cÃ¡c Ã´ trong 1 cá»™t
  function getCellsPositionsInCol(table, colIndex) {
    const positions = [];
    let rowPos = 0;
    for (let r = 0; r < table.rows.length; r++) {
      const row = table.rows[r];
      let colCount = 0;
      for (const cell of row.cells) {
        const colSpan = cell.colSpan || 1;
        const rowSpan = cell.rowSpan || 1;
        if (colCount === colIndex) {
          positions.push({ cell, startRow: rowPos, rowSpan });
          break;
        }
        colCount += colSpan;
      }
      rowPos++;
    }
    return positions;
  }

  // Kiá»ƒm tra cÃ¡c Ã´ cÃ³ liá»n ká» trong 1 cá»™t khÃ´ng
  function areCellsContiguousInCol(table, colIndex, selectedCells) {
    const positions = getCellsPositionsInCol(table, colIndex);

    const selectedPositions = positions.filter(p => selectedCells.includes(p.cell));

    // Sáº¯p xáº¿p theo vá»‹ trÃ­ hÃ ng áº£o
    selectedPositions.sort((a, b) => a.startRow - b.startRow);

    for (let i = 1; i < selectedPositions.length; i++) {
      const prev = selectedPositions[i - 1];
      const curr = selectedPositions[i];
      if (prev.startRow + prev.rowSpan !== curr.startRow) {
        return false;
      }
    }
    return true;
  }

  // HÃ m táº¡o ma tráº­n 2D báº£ng (dÃ¹ng cho vá»‹ trÃ­ thá»±c táº¿ cá»§a cÃ¡c Ã´, há»— trá»£ rowspan/colspan)
function buildTableMatrix(table) {
  const matrix = [];
  const rows = table.rows.length;
  for (let r = 0; r < rows; r++) matrix[r] = [];
  for (let r = 0; r < rows; r++) {
    const row = table.rows[r];
    let colPos = 0;
    for (let c = 0; c < row.cells.length; c++) {
      const cell = row.cells[c];
      const rowSpan = cell.rowSpan || 1;
      const colSpan = cell.colSpan || 1;

      // TÃ¬m vá»‹ trÃ­ trá»‘ng Ä‘áº§u tiÃªn trÃªn hÃ ng r
      while (matrix[r][colPos]) colPos++;

      // ÄÃ¡nh dáº¥u cell chiáº¿m vá»‹ trÃ­ (r..r+rowSpan, colPos..colPos+colSpan)
      for (let rs = 0; rs < rowSpan; rs++) {
        for (let cs = 0; cs < colSpan; cs++) {
          matrix[r + rs][colPos + cs] = cell;
        }
      }

      colPos += colSpan;
    }
  }
  return matrix;
}

// HÃ m láº¥y vá»‹ trÃ­ (row, col) thá»±c táº¿ cá»§a cÃ¡c Ã´ Ä‘Æ°á»£c chá»n
function getSelectedCellsPositions(table, selectedCells) {
  const matrix = buildTableMatrix(table);
  const positions = [];
  for (let r = 0; r < matrix.length; r++) {
    for (let c = 0; c < matrix[r].length; c++) {
      const cell = matrix[r][c];
      if (selectedCells.includes(cell)) {
        if (!positions.find(p => p.cell === cell)) {
          positions.push({ cell, rowIndex: r, colIndex: c });
        }
      }
    }
  }
  return positions;
}

// Kiá»ƒm tra cÃ¡c Ã´ cÃ³ liá»n ká» trong cÃ¹ng hÃ ng
function areCellsContiguousInRow(positions) {
  const row = positions[0].rowIndex;
  if (!positions.every(p => p.rowIndex === row)) return false;

  const cols = positions.map(p => p.colIndex).sort((a, b) => a - b);

  for (let i = 1; i < cols.length; i++) {
    if (cols[i] !== cols[i - 1] + 1) return false;
  }
  return true;
}

// Kiá»ƒm tra cÃ¡c Ã´ cÃ³ liá»n ká» trong cÃ¹ng cá»™t
function areCellsContiguousInCol(positions) {
  const col = positions[0].colIndex;
  if (!positions.every(p => p.colIndex === col)) return false;

  const rows = positions.map(p => p.rowIndex).sort((a, b) => a - b);

  for (let i = 1; i < rows.length; i++) {
    if (rows[i] !== rows[i - 1] + 1) return false;
  }
  return true;
}

// HÃ m gá»™p Ã´ Ä‘Æ°á»£c chá»n, dÃ¹ng ma tráº­n vá»‹ trÃ­ chÃ­nh xÃ¡c vÃ  set colSpan/rowSpan + width/height
confirmMergeBtn.onclick = () => {
  const checkboxes = table.querySelectorAll('.table-cell-checkbox:checked');
  const selectedCells = Array.from(checkboxes).map(cb => cb.closest('td'));

  if (selectedCells.length <= 1) {
    alert('Chá»n Ã­t nháº¥t 2 Ã´ Ä‘á»ƒ gá»™p');
    return;
  }

  const positions = getSelectedCellsPositions(table, selectedCells);

  const sameRow = positions.every(p => p.rowIndex === positions[0].rowIndex);
  const sameCol = positions.every(p => p.colIndex === positions[0].colIndex);

  if (!sameRow && !sameCol) {
    alert('Chá»‰ cÃ³ thá»ƒ gá»™p cÃ¡c Ã´ cÃ¹ng hÃ ng hoáº·c cÃ¹ng cá»™t!');
    return;
  }

  if (sameRow) {
    if (!areCellsContiguousInRow(positions)) {
      alert('CÃ¡c Ã´ trong cÃ¹ng hÃ ng pháº£i liá»n ká» Ä‘á»ƒ gá»™p');
      return;
    }

    positions.sort((a, b) => a.colIndex - b.colIndex);

    const main = positions[0].cell;
    let content = '';

    positions.forEach((pos, idx) => {
      const ta = pos.cell.querySelector('textarea');
      if (ta && ta.value.trim()) content += (idx === 0 ? '' : '\n') + ta.value;
      if (idx > 0) pos.cell.remove();
    });

    const taMain = main.querySelector('textarea');
    taMain.value = content;

    main.colSpan = positions.length;
    main.style.width = ''; // Bá» set width thá»§ cÃ´ng, Ä‘á»ƒ trÃ¬nh duyá»‡t tá»± tÃ­nh
    main.style.height = ''; // Reset chiá»u cao náº¿u cÃ³
    main.rowSpan = 1;
  }
 else if (sameCol) {
  if (!areCellsContiguousInCol(positions)) {
    alert('CÃ¡c Ã´ trong cÃ¹ng cá»™t pháº£i liá»n ká» Ä‘á»ƒ gá»™p');
    return;
  }

  positions.sort((a, b) => a.rowIndex - b.rowIndex);

  const main = positions[0].cell;
  let content = '';

  positions.forEach((pos, idx) => {
    const ta = pos.cell.querySelector('textarea');
    if (ta && ta.value.trim()) content += (idx === 0 ? '' : '\n') + ta.value;
    if (idx > 0) pos.cell.remove();
  });

  const taMain = main.querySelector('textarea');
  taMain.value = content;

  main.rowSpan = positions.length;
  main.colSpan = 1;
  main.style.width = ''; // reset chiá»u rá»™ng náº¿u cÃ³

  // TÃ­nh chiá»u cao 1 Ã´ chuáº©n (rowSpan=1) á»Ÿ cá»™t gá»™p
  let singleCellHeight = 0;
  const colIndex = positions[0].colIndex;
  for (let r = 0; r < table.rows.length; r++) {
    let colCount = 0;
    const row = table.rows[r];
    for (const cell of row.cells) {
      if (colCount === colIndex && (cell.rowSpan || 1) === 1) {
        singleCellHeight = cell.getBoundingClientRect().height;
        break;
      }
      colCount += cell.colSpan || 1;
    }
    if (singleCellHeight) break;
  }

  if (singleCellHeight) {
    main.style.height = (singleCellHeight * positions.length) + 'px';
  } else {
    main.style.height = '';
  }
}


  // Reset láº¡i tráº¡ng thÃ¡i chá»n vÃ  áº©n checkbox
  isSelecting = false;
  selectBtn.style.display = 'inline-block';
  confirmMergeBtn.style.display = 'none';
  cancelMergeBtn.style.display = 'none';

  const allCheckboxes = table.querySelectorAll('.table-cell-checkbox');
  allCheckboxes.forEach(cb => {
    cb.checked = false;
    cb.style.display = 'none';
  });
};



  wrapper.appendChild(title);
  wrapper.appendChild(config);
  wrapper.appendChild(table);
  container.appendChild(wrapper);
}



// ThÃªm Ã´ ná»™i dung phá»¥ (textarea) trong má»¥c con
function addExtraContent(button, containerOverride, level = 1) {
  const container = containerOverride || button.closest('.report-pvt-create__group').querySelector('.report-section__children');

  const wrapper = document.createElement('div');
  wrapper.className = 'report-subitem-extra';

  wrapper.style.backgroundColor = '#f9f9f9';
  wrapper.style.marginBottom = '10px';

  const textarea = document.createElement('textarea');
  textarea.placeholder = 'Ná»™i dung';
  textarea.rows = 2;
  textarea.style.width = '100%';
  textarea.style.resize = 'vertical';
  textarea.addEventListener('input', () => autoResizeTextarea(textarea));
  autoResizeTextarea(textarea);

  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.textContent = 'âŒ XoÃ¡ ná»™i dung';
  removeBtn.style.marginTop = '6px';
  removeBtn.style.backgroundColor = '#d35454';
  removeBtn.style.color = 'white';
  removeBtn.style.border = 'none';
  removeBtn.style.padding = '4px 8px';
  removeBtn.style.borderRadius = '5px';
  removeBtn.style.cursor = 'pointer';

  removeBtn.onmouseenter = () => (removeBtn.style.backgroundColor = '#a82727');
  removeBtn.onmouseleave = () => (removeBtn.style.backgroundColor = '#d35454');
  removeBtn.onclick = () => wrapper.remove();

  wrapper.appendChild(textarea);
  wrapper.appendChild(removeBtn);

  container.appendChild(wrapper);
}

function collectTableData(tableEl) {
  const rows = tableEl?.rows || [];
  const matrix = []; // ma tráº­n 2D Ä‘Ã¡nh dáº¥u Ã´ Ä‘Ã£ láº¥y

  const cellsData = [];

  for (let r = 0; r < rows.length; r++) {
    const row = rows[r];
    let colIndex = 0;

    cellsData[r] = [];

    for (let c = 0; c < row.cells.length; c++) {
      // TÃ¬m colIndex trá»‘ng tiáº¿p theo trong ma tráº­n
      while (matrix[r] && matrix[r][colIndex]) {
        colIndex++;
      }

      const cell = row.cells[c];
      const textarea = cell.querySelector('textarea');

      const rowSpan = cell.rowSpan || 1;
      const colSpan = cell.colSpan || 1;

      // Chá»‰ láº¥y Ã´ gá»‘c (Ã´ Ä‘áº§u tiÃªn trong vÃ¹ng gá»™p)
      cellsData[r][colIndex] = {
        text: textarea ? textarea.value.trim() : '',
        rowSpan,
        colSpan
      };

      // ÄÃ¡nh dáº¥u cÃ¡c Ã´ trong vÃ¹ng gá»™p trong ma tráº­n Ä‘á»ƒ bá» qua sau
      for (let rs = 0; rs < rowSpan; rs++) {
        for (let cs = 0; cs < colSpan; cs++) {
          if (!matrix[r + rs]) matrix[r + rs] = [];
          matrix[r + rs][colIndex + cs] = true;
        }
      }

      colIndex += colSpan;
    }
  }

  return cellsData;
}


  // Thu tháº­p dá»¯ liá»‡u Ä‘á»‡ quy má»¥c con + báº£ng, Ä‘Ãºng thá»© tá»±
function collectSectionData(section) {
  const group = document.querySelector(`[data-section="${section}"]`);
  if (!group) return [];

  const container = group.querySelector('.report-section__children');
  if (!container) return [];

  const results = [];

  Array.from(container.children).forEach(child => {
    if (child.classList.contains('report-subitem')) {
      const textareas = child.querySelectorAll('textarea');
      const title = textareas[0]?.value.trim() || '';
      const content = textareas[1]?.value.trim() || '';
      // Thu tháº­p con lá»“ng bÃªn trong
      const subContainer = child.querySelector('.report-section__children');
      const children = subContainer ? collectSectionChildren(subContainer) : [];

      results.push({ type: 'text', title, content, children });
    } else if (child.classList.contains('report-subtable')) {
  const title = child.querySelector('textarea')?.value.trim() || '';
  const tableEl = child.querySelector('table');

  const cells = collectTableData(tableEl);

  results.push({ type: 'table', title, cells });
}

  });

  return results;
}

// Thu tháº­p Ä‘á»‡ quy con bÃªn trong má»¥c con (dÃ¹ng cho children)
function collectSectionChildren(container) {
  const results = [];
  Array.from(container.children).forEach(child => {
    if (child.classList.contains('report-subitem')) {
      const textareas = child.querySelectorAll('textarea');
      const title = textareas[0]?.value.trim() || '';
      const content = textareas[1]?.value.trim() || '';
      const subContainer = child.querySelector('.report-section__children');
      const children = subContainer ? collectSectionChildren(subContainer) : [];
      results.push({ type: 'text', title, content, children });
    } else if (child.classList.contains('report-subtable')) {
      const title = child.querySelector('textarea')?.value.trim() || '';
      const tableEl = child.querySelector('table');
      const rows = tableEl?.rows || [];

      const cells = [];
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const rowData = [];
        for (let j = 0; j < row.cells.length; j++) {
          const cell = row.cells[j];
          const textarea = cell.querySelector('textarea');
          rowData.push({
            text: textarea ? textarea.value.trim() : '',
            rowSpan: cell.rowSpan || 1,
            colSpan: cell.colSpan || 1
          });
        }
        cells.push(rowData);
      }

      results.push({ type: 'table', title, cells });
    }
  });
  return results;
}


  // Gá»­i dá»¯ liá»‡u form + má»¥c con + báº£ng
  // Gá»­i dá»¯ liá»‡u
    document.getElementById('createReportForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const form = e.target;
    const data = {
      reportName: form.reportName.value,
      number: form.number.value,
      recipient: form.recipient.value,
      createdAt: form.createdAt.value,
      receivers: form.receivers.value,
      signer: form.signer.value,
      position: form.position.value,
      sections: {}
    };

    const sectionKeys = ['bscKpi', 'tuh', 'ptm', 'cntt', 'vhm', 'khcp', 'conclusion', 'kientnghi_ldtt', 'kientnghi_dvkhac', 'kehoach_tuh', 'kehoach_ptm', 'kehoach_cntt', 'kehoach_vhm', 'kehoach_khcp'];

    sectionKeys.forEach(section => {
      data.sections[section] = collectSectionData(section);
    });

    console.log('Dá»¯ liá»‡u gá»­i lÃªn:', data);

    fetch('/report/pvt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    }).then(res => res.json())
      .then(result => {
        if (result.success) alert('LÆ°u bÃ¡o cÃ¡o thÃ nh cÃ´ng!');
        
        else alert('Lá»—i lÆ°u bÃ¡o cÃ¡o');
      }).catch(() => alert('Lá»—i káº¿t ná»‘i server'));
  });

  // GÃ¡n sá»± kiá»‡n nÃºt thÃªm má»¥c con cáº¥p 1
  
</script>

