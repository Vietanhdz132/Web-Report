<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-resizable-columns@0.2.3/resizable-columns.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-resizable-columns@0.2.3/jquery.resizableColumns.min.js"></script>

<div class="report-pvt-create">
  <h1 class="report-pvt-create__title">Táº¡o bÃ¡o cÃ¡o má»›i - PhÃ²ng VÃ´ Tuyáº¿n</h1>

  <form id="createReportForm" class="report-pvt-create__form">
    <!-- ThÃ´ng tin chung -->
    <div class="report-pvt-create__group">
      <label for="reportName">TÃªn bÃ¡o cÃ¡o</label>
      <select id="reportName" name="reportName" required>
        <option value="">-- Chá»n tuáº§n --</option>
        <!-- Táº¡o tuáº§n tá»« 1 Ä‘áº¿n 54 -->
        <!-- CÃ³ thá»ƒ táº¡o tá»± Ä‘á»™ng báº±ng JavaScript (xem dÆ°á»›i) -->
      </select>
    </div>

    <div class="report-pvt-create__group">
      <label for="recipient">KÃ­nh gá»­i</label>
      <input
        id="recipient"
        name="recipient"
        type="text"
        value="GiÃ¡m Ä‘á»‘c Trung tÃ¢m Máº¡ng lÆ°á»›i MobiFone miá»n Báº¯c"
        placeholder="VD: GiÃ¡m Ä‘á»‘c Trung tÃ¢m Máº¡ng lÆ°á»›i MobiFone miá»n Báº¯c"
        required
      />
    </div>

    <div class="report-pvt-create__group">
      <label for="number">Sá»‘ hiá»‡u</label>
      <input id="number" name="number" type="text" >
    </div>

    {{!-- <div class="report-pvt-create__group">
      <label for="receivers">KÃ­nh gá»­i</label>
      <textarea id="receivers" name="receivers" rows="3"
        placeholder="Nháº­p danh sÃ¡ch ngÆ°á»i nháº­n" required></textarea>
    </div> --}}

    <div class="report-pvt-create__group">
      <label for="createdAt">NgÃ y táº¡o</label>
      <input id="createdAt" name="createdAt" type="date" required />
    </div>

    <!-- I. ÄÃ¡nh giÃ¡ káº¿t quáº£ triá»ƒn khai -->
    <hr />
    <h2>I. ÄÃNH GIÃ Káº¾T QUáº¢ TRIá»‚N KHAI</h2>

    <div class="report-pvt-create__group" data-section="bscKpi">
      <h4>1. Káº¿t quáº£ thá»±c hiá»‡n BSC-KPI</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'bscKpi')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'bscKpi')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <h4>2. CÃ´ng viá»‡c trá»ng tÃ¢m</h4>

    <div class="report-pvt-create__group" data-section="tuh">
      <label for="tuh">CÃ´ng tÃ¡c TUH</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'tuh')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'tuh')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="ptm">
      <label for="ptm">CÃ´ng tÃ¡c PTM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'ptm')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'ptm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="cntt">
      <label for="cntt">CÃ´ng tÃ¡c CNTT</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'cntt')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'cntt')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="vhm">
      <label for="vhm">CÃ´ng tÃ¡c VHM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'vhm')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'vhm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="khcp">
      <label for="khcp">CÃ´ng tÃ¡c KHCP</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'khcp')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'khcp')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- II. Káº¿t luáº­n chá»‰ Ä‘áº¡o -->
    <hr />
    <h2>II. THá»°C HIá»†N Káº¾T LUáº¬N, CHá»ˆ Äáº O</h2>
    <div class="report-pvt-create__group" data-section="conclusion">
      <h4>Ná»™i dung káº¿t luáº­n, chá»‰ Ä‘áº¡o</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'conclusion')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'conclusion')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- III. Tá»“n táº¡i, kiáº¿n nghá»‹ -->
    <hr />
    <h2>III. Tá»’N Táº I, KIáº¾N NGHá»Š</h2>
    <div class="report-pvt-create__group" data-section="kientnghi_ldtt">
      <h4>1. Kiáº¿n nghá»‹ vá»›i LÄTT/TCT</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'kientnghi_ldtt')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'kientnghi_ldtt')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kientnghi_dvkhac">
      <h4>2. Kiáº¿n nghá»‹ vá»›i Ä‘Æ¡n vá»‹ khÃ¡c</h4>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'kientnghi_dvkhac')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'kientnghi_dvkhac')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- IV. Káº¿ hoáº¡ch tuáº§n tá»›i -->
    <hr />
    <h2 id="nextWeekHeading">IV. Káº¾ HOáº CH TUáº¦N Tá»šI</h2>

    <div class="report-pvt-create__group" data-section="kehoach_tuh">
      <label>CÃ´ng tÃ¡c TUH</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'kehoach_tuh')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'kehoach_tuh')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_ptm">
      <label>CÃ´ng tÃ¡c PTM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'kehoach_ptm')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'kehoach_ptm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_cntt">
      <label>CÃ´ng tÃ¡c CNTT</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'kehoach_cntt')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'kehoach_cntt')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_vhm">
      <label>CÃ´ng tÃ¡c VHM</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'kehoach_vhm')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'kehoach_vhm')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <div class="report-pvt-create__group" data-section="kehoach_khcp">
      <label>CÃ´ng tÃ¡c KHCP</label>
      <div class="report-section__children"></div>
      <div class="report-section__tools">
        <button type="button" class="btn-add-subitem"
          onclick="addChild(this, 'kehoach_khcp')">â• ThÃªm má»¥c</button>
        <button type="button" class="btn-add-table"
          onclick="addTable(this, 'kehoach_khcp')">ğŸ“Š ThÃªm báº£ng</button>
      </div>
    </div>

    <!-- NÆ¡i nháº­n -->
    <hr />
    <h2>NÆ I NHáº¬N</h2>
    <div class="report-pvt-create__group">
      <label for="receivers">NÆ¡i nháº­n</label>
      <textarea id="receivers" name="receivers" rows="4" required>
      </textarea>
    </div>

    <!-- KÃ½ tÃªn -->
    <hr />
    <h2>ThÃ´ng tin kÃ½ bÃ¡o cÃ¡o</h2>
    <div class="report-pvt-create__group">
      <label for="signer">NgÆ°á»i kÃ½</label>
      <input id="signer" name="signer" type="text" required />
    </div>
    <div class="report-pvt-create__group">
      <label for="position">Chá»©c vá»¥</label>
      <input id="position" name="position" type="text" required />
    </div>

    <div class="report-pvt-create__actions">
      <button type="submit">ğŸ’¾ LÆ°u bÃ¡o cÃ¡o</button>
      <a href="/report" class="btn-cancel">Há»§y</a>
    </div>
  </form>
</div>

<style>
  /* Style cho select */
  #reportName {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
    background-color: #ffffff;
    color: #333;
  }

  /* Style cho option â€“ bá»‹ giá»›i háº¡n á»Ÿ nhiá»u trÃ¬nh duyá»‡t */
  #reportName option {
    padding: 10px;
    font-size: 15px;
    color: #012d5a;
    background-color: #fff;
  }

  /* Tuá»³ chá»n: Style khi focus */
  #reportName:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }
</style>

<script>
  const select = document.getElementById('reportName');
  const numberInput = document.getElementById('number');

  // Táº¡o option tá»« tuáº§n 1 Ä‘áº¿n 53
  for (let i = 1; i <= 53; i++) {
    const option = document.createElement('option');
    option.value = `BÃO CÃO TUáº¦N ${i}`;        
    option.dataset.week = i;                  
    option.textContent = `BÃO CÃO TUáº¦N ${i}`;
    select.appendChild(option);
  }

  // Khi chá»n tuáº§n, cáº­p nháº­t sá»‘ hiá»‡u
  select.addEventListener('change', function () {
    const selectedOption = this.options[this.selectedIndex];
    const weekNumber = selectedOption.dataset.week;
    numberInput.value = weekNumber || '';
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('createdAt').value = today;
  });
</script>


<script>
  const reportName = document.getElementById('reportName');
const heading = document.getElementById('nextWeekHeading');

function updateNextWeekHeading() {
  const selectedOption = reportName.options[reportName.selectedIndex];
  const match = selectedOption?.value?.match(/TUáº¦N\s+(\d+)/i);

  if (match) {
    const week = parseInt(match[1], 10);
    const nextWeek = week + 1;
    heading.textContent = `IV. Káº¾ HOáº CH TUáº¦N ${nextWeek}`;
  } else {
    heading.textContent = `IV. Káº¾ HOáº CH TUáº¦N Tá»šI`;
  }
}

// Gá»i láº§n Ä‘áº§u (khi cÃ³ sáºµn reportName tá»« DB)
updateNextWeekHeading();

// Cáº­p nháº­t khi ngÆ°á»i dÃ¹ng thay Ä‘á»•i chá»n
reportName.addEventListener('change', updateNextWeekHeading);

</script>

<script>
  document.querySelector('.btn-cancel').addEventListener('click', function (e) {
    const confirmed = confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n há»§y khÃ´ng?');
    if (!confirmed) {
      e.preventDefault();
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('createdAt').value = today;
  });
</script>
<script>
  
  function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto';        // reset chiá»u cao
  textarea.style.height = textarea.scrollHeight + 'px'; // Ä‘áº·t láº¡i theo ná»™i dung
  textarea.style.transition = 'height 0.2s ease';
}

// ThÃªm má»¥c (chá»‰ cÃ³ 1 cáº¥p con thÃ´i, khÃ´ng lá»“ng tiáº¿p)
function addChild(button, section, containerOverride) {
  const container = containerOverride || button.closest('.report-pvt-create__group').querySelector('.report-section__children');

  const wrapper = document.createElement('div');
  wrapper.className = 'report-subitem';
  wrapper.style.marginBottom = '10px';
  wrapper.style.border = '1px solid #ccc';
  wrapper.style.padding = '10px';
  wrapper.style.borderRadius = '8px';
  wrapper.style.backgroundColor = '#fffff';

  // **Thay textarea ná»™i dung thÃ nh textarea "title"**
  const titleTextarea = document.createElement('textarea');
  titleTextarea.placeholder = 'TiÃªu Ä‘á» má»¥c con';
  titleTextarea.rows = 1;
  titleTextarea.style.width = '100%';
  titleTextarea.style.marginBottom = '6px';
  titleTextarea.style.resize = 'vertical';
  titleTextarea.style.fontWeight = '700';
  titleTextarea.addEventListener('input', () => autoResizeTextarea(titleTextarea));
  autoResizeTextarea(titleTextarea);

  // VÃ¹ng chá»©a ná»™i dung phá»¥ (báº£ng, ná»™i dung con)
  const itemsContainer = document.createElement('div');
  itemsContainer.className = 'report-section__children';
  itemsContainer.style.marginTop = '10px';
  itemsContainer.style.borderLeft = '2px dashed #aaa';
  itemsContainer.style.paddingLeft = '10px';
  itemsContainer.style.backgroundColor = '#ffffff';

  // NhÃ³m nÃºt dÆ°á»›i cÃ¹ng (3 nÃºt cÃ¹ng hÃ ng)
  const buttonGroup = document.createElement('div');
  buttonGroup.style.display = 'flex';
  buttonGroup.style.justifyContent = 'space-between';
  buttonGroup.style.gap = '10px';
  buttonGroup.style.marginTop = '10px';
  buttonGroup.style.marginLeft = '0'; 

  // NÃºt XoÃ¡ má»¥c con
  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.textContent = 'âŒ XoÃ¡ má»¥c';
  removeBtn.onclick = () => {
    if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xoÃ¡ má»¥c nÃ y khÃ´ng?')) {
      wrapper.remove();
    }
  };

  // NÃºt ThÃªm báº£ng (mÃ u xanh)
  const addTableBtn = document.createElement('button');
  addTableBtn.type = 'button';
  addTableBtn.textContent = 'ğŸ“Š ThÃªm báº£ng';
  addTableBtn.style.backgroundColor = '#007acc';
  addTableBtn.style.color = '#fff';
  addTableBtn.style.border = 'none';
  addTableBtn.style.padding = '6px 12px';
  addTableBtn.style.borderRadius = '5px';
  addTableBtn.style.cursor = 'pointer';
  addTableBtn.style.fontWeight = '600';
  addTableBtn.onclick = () => addTable(addTableBtn, section, itemsContainer);

  // NÃºt ThÃªm ná»™i dung 
  const addExtraBtn = document.createElement('button');
  addExtraBtn.type = 'button';
  addExtraBtn.textContent = 'â• ThÃªm ná»™i dung';
  addExtraBtn.style.backgroundColor = '#007acc';
  addExtraBtn.style.color = '#fff';
  addExtraBtn.style.border = 'none';
  addExtraBtn.style.padding = '6px 12px';
  addExtraBtn.style.borderRadius = '5px';
  addExtraBtn.style.cursor = 'pointer';
  addExtraBtn.style.fontWeight = '600';
  addExtraBtn.onmouseenter = () => (addExtraBtn.style.backgroundColor = '#005fa3');
  addExtraBtn.onmouseleave = () => (addExtraBtn.style.backgroundColor = '#007acc');
  addExtraBtn.onclick = () => addExtraContent(addExtraBtn, itemsContainer);

  // Gá»™p vÃ o nhÃ³m nÃºt
  buttonGroup.appendChild(addExtraBtn);
  buttonGroup.appendChild(addTableBtn);
  buttonGroup.appendChild(removeBtn);

  wrapper.appendChild(titleTextarea);
  wrapper.appendChild(itemsContainer);
  wrapper.appendChild(buttonGroup);
  container.appendChild(wrapper);
}


function addTable(button, section, containerOverride, level = 1) {
  const container = containerOverride || button.closest('.report-pvt-create__group').querySelector('.report-section__children');

  const wrapper = document.createElement('div');
  wrapper.className = 'report-subtable';
 

  const title = document.createElement('textarea');
  title.placeholder = 'TiÃªu Ä‘á» báº£ng';
  title.rows = 1;
  title.style.width = '100%';
  title.style.resize = 'none';
  title.style.marginBottom = '10px';
  title.style.fontWeight = '600';
  title.addEventListener('input', () => autoResizeTextarea(title));
  autoResizeTextarea(title);

  const config = document.createElement('div');
  config.style.display = 'flex';
  config.style.alignItems = 'center';



  const rowsLabel = document.createElement('label');
  rowsLabel.textContent = 'Sá»‘ hÃ ng:';
  const rowsInput = document.createElement('input');
  rowsInput.type = 'number';
  rowsInput.min = 1;
  rowsInput.value = 3;
  rowsInput.style.width = '60px';
  rowsInput.style.marginLeft = '6px';
  rowsLabel.appendChild(rowsInput);

  const colsLabel = document.createElement('label');
  colsLabel.textContent = 'Sá»‘ cá»™t:';
  const colsInput = document.createElement('input');
  colsInput.type = 'number';
  colsInput.min = 1;
  colsInput.value = 3;
  colsInput.style.width = '60px';
  colsInput.style.marginLeft = '6px';
  colsLabel.style.marginLeft = '20px';
  colsLabel.appendChild(colsInput);

  const createBtn = document.createElement('button');
  createBtn.type = 'button';
  createBtn.textContent = 'Táº¡o báº£ng';
  Object.assign(createBtn.style, {
  
    cursor: 'pointer',
    border: 'none',
    borderRadius: '5px',
    backgroundColor: '#0078d7',
    color: 'white',
    fontWeight: '600'
  });
  const pasteBtn = document.createElement('button');
  pasteBtn.type = 'button';
  pasteBtn.textContent = 'ğŸ“‹ DÃ¡n dá»¯ liá»‡u';
  Object.assign(pasteBtn.style, {
    backgroundColor: '#6f42c1',
    color: 'white',
    border: 'none',
    padding: '6px 12px',
    borderRadius: '5px',
    cursor: 'pointer',
    fontWeight: '600',
  });

  const selectBtn = document.createElement('button');
  selectBtn.type = 'button';
  selectBtn.textContent = 'Chá»n Ã´ cáº§n gá»™p';
  Object.assign(selectBtn.style, {

    cursor: 'pointer',
    border: 'none',
    borderRadius: '5px',
    backgroundColor: '#ffc107',
    color: '#000',
    fontWeight: '600',
  });

  const confirmMergeBtn = document.createElement('button');
  confirmMergeBtn.type = 'button';
  confirmMergeBtn.textContent = 'Gá»™p cÃ¡c Ã´ Ä‘Ã£ chá»n';
  confirmMergeBtn.style.display = 'none';
  Object.assign(confirmMergeBtn.style, {

    cursor: 'pointer',
    border: 'none',
    borderRadius: '5px',
    backgroundColor: '#28a745',
    color: 'white',
    fontWeight: '600'
  });

  const cancelMergeBtn = document.createElement('button');
  cancelMergeBtn.type = 'button';
  cancelMergeBtn.textContent = 'Huá»·';
  cancelMergeBtn.style.display = 'none';
  Object.assign(cancelMergeBtn.style, {
    padding: '6px 12px',
    cursor: 'pointer',
    border: 'none',
    borderRadius: '5px',
    backgroundColor: '#dc3545',
    color: 'white',
    fontWeight: '600'
  });

  const deleteTableBtn = document.createElement('button');
      deleteTableBtn.type = 'button';
      deleteTableBtn.textContent = 'âŒ XoÃ¡ báº£ng';
      Object.assign(deleteTableBtn.style, {
        backgroundColor: '#e94e4e',
        color: 'white',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });

      deleteTableBtn.onclick = () => {
        if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xoÃ¡ báº£ng nÃ y khÃ´ng?')) {
          wrapper.remove();
        }
      };

      const addRowBtn = document.createElement('button');
        addRowBtn.type = 'button';
        addRowBtn.textContent = 'â• ThÃªm hÃ ng';
        Object.assign(addRowBtn.style, {
          backgroundColor: '#17a2b8',
          color: 'white',
          border: 'none',
          padding: '6px 12px',
          borderRadius: '5px',
          cursor: 'pointer',
          fontWeight: '600',
        });
        
        addRowBtn.onclick = () => {
          const newRow = document.createElement('tr');

          // Náº¿u cÃ³ dÃ²ng nÃ o rá»“i thÃ¬ táº¡o sá»‘ cá»™t báº±ng dÃ²ng Ä‘áº§u tiÃªn
          const numCols = table.rows[0]?.cells.length || 3; // máº·c Ä‘á»‹nh 3 cá»™t náº¿u chÆ°a cÃ³ dÃ²ng nÃ o

          for (let i = 0; i < numCols; i++) {
            const td = document.createElement('td');

            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'table-cell-wrapper';
            wrapperDiv.style.position = 'relative';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'table-cell-checkbox';
            Object.assign(checkbox.style, {
              position: 'absolute',
              top: '0px',
              right: '0px',
              width: '30px',
              height: '14px',
              zIndex: '1',
              display: 'none',
            });

            const textarea = document.createElement('textarea');
            textarea.rows = 1;
            textarea.value = '';
            Object.assign(textarea.style, {
              width: '100%',
              height: '100%',
              border: 'none', // âœ¨ bá» viá»n
              resize: 'none',
              padding: '6px',
              boxSizing: 'border-box',
              fontFamily: 'inherit',
              backgroundColor:'#ffffff',
            });
            textarea.addEventListener('input', () => autoResizeTextarea(textarea));
            requestAnimationFrame(() => autoResizeTextarea(textarea));

            wrapperDiv.appendChild(checkbox);
            wrapperDiv.appendChild(textarea);
            td.appendChild(wrapperDiv);
            newRow.appendChild(td);
          }

          table.appendChild(newRow);
        };

        // NÃºt xoÃ¡ hÃ ng cuá»‘i
      const deleteRowBtn = document.createElement('button');
      deleteRowBtn.type = 'button';
      deleteRowBtn.textContent = 'â– XoÃ¡ hÃ ng cuá»‘i';
      Object.assign(deleteRowBtn.style, {
        backgroundColor: '#ff9800',
        color: 'white',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });
      deleteRowBtn.onmouseenter = () => (deleteRowBtn.style.backgroundColor = '#e68a00');
      deleteRowBtn.onmouseleave = () => (deleteRowBtn.style.backgroundColor = '#ff9800');
      deleteRowBtn.onclick = () => {
        if (table.rows.length > 0) {
          table.deleteRow(table.rows.length - 1);
        }
      };


      const tableFooter = document.createElement('div');
      Object.assign(tableFooter.style, {
        display: 'flex',
        justifyContent: 'space-between', // cÄƒn 2 Ä‘áº§u trÃ¡i pháº£i
        marginTop: '10px',
      });

      // Container bÃªn trÃ¡i (chá»©a nÃºt XoÃ¡ báº£ng)
      const rightContainer = document.createElement('div');
      rightContainer.appendChild(deleteTableBtn);
      

      // Container bÃªn pháº£i (chá»©a 3 nÃºt cÃ²n láº¡i)
      const leftContainer = document.createElement('div');
      leftContainer.style.display = 'flex';
      leftContainer.style.gap = '10px'; // khoáº£ng cÃ¡ch giá»¯a cÃ¡c nÃºt
      leftContainer.appendChild(pasteBtn);
      leftContainer.appendChild(addRowBtn);
      leftContainer.appendChild(deleteRowBtn);

      // Gáº¯n 2 container vÃ o footer
      tableFooter.appendChild(leftContainer);
      tableFooter.appendChild(rightContainer);



      config.appendChild(rowsLabel);
      config.appendChild(colsLabel);
      config.appendChild(createBtn);
      config.appendChild(selectBtn);
      config.appendChild(confirmMergeBtn);
      config.appendChild(cancelMergeBtn);
    
    // **NÃºt dÃ¡n dá»¯ liá»‡u clipboard**
  

  // Popup modal dÃ¡n dá»¯ liá»‡u (áº©n máº·c Ä‘á»‹nh)
  const pasteModal = document.createElement('div');
  Object.assign(pasteModal.style, {
    position: 'fixed',
    top: '0', left: '0', right: '0', bottom: '0',
    backgroundColor: 'rgba(0,0,0,0.5)',
    display: 'none',
    justifyContent: 'center',
    alignItems: 'center',
    zIndex: '1000',
  });

  const pasteModalContent = document.createElement('div');
  Object.assign(pasteModalContent.style, {
    backgroundColor: 'white',
    padding: '20px',
    borderRadius: '8px',
    width: '60%',
    maxWidth: '90%',
    display: 'flex',
    flexDirection: 'column',
  });

  const pasteTextarea = document.createElement('textarea');
  pasteTextarea.placeholder = 'DÃ¡n dá»¯ liá»‡u báº£ng táº¡i Ä‘Ã¢y (tá»« Excel, Sheets, ...)';
  pasteTextarea.style.width = '100%';
  pasteTextarea.style.height = '150px';
  pasteTextarea.style.resize = 'vertical';
  pasteTextarea.style.marginBottom = '12px';
  pasteTextarea.style.fontFamily = 'monospace';

  const pasteButtons = document.createElement('div');
  pasteButtons.style.display = 'flex';
  pasteButtons.style.justifyContent = 'flex-end';
  pasteButtons.style.gap = '10px';

  const pasteConfirmBtn = document.createElement('button');
  pasteConfirmBtn.type = 'button';
  pasteConfirmBtn.textContent = 'Nháº­p dá»¯ liá»‡u vÃ o báº£ng';
  Object.assign(pasteConfirmBtn.style, {
    backgroundColor: '#28a745',
    color: 'white',
    border: 'none',
    padding: '6px 12px',
    borderRadius: '5px',
    cursor: 'pointer',
    fontWeight: '600',
  });

  const pasteCancelBtn = document.createElement('button');
  pasteCancelBtn.type = 'button';
  pasteCancelBtn.textContent = 'Huá»·';
  Object.assign(pasteCancelBtn.style, {
    backgroundColor: '#dc3545',
    color: 'white',
    border: 'none',
    padding: '6px 12px',
    borderRadius: '5px',
    cursor: 'pointer',
    fontWeight: '600',
  });

  pasteButtons.appendChild(pasteCancelBtn);
  pasteButtons.appendChild(pasteConfirmBtn);

  pasteModalContent.appendChild(pasteTextarea);
  pasteModalContent.appendChild(pasteButtons);
  pasteModal.appendChild(pasteModalContent);

  // ThÃªm modal vÃ o body
  document.body.appendChild(pasteModal);

  function createStyledTextarea(value = '') {
    const textarea = document.createElement('textarea');
    textarea.value = value;
    textarea.rows = 1;
    textarea.style.width = '100%';
    textarea.style.resize = 'none';
    textarea.style.fontFamily = 'inherit';
    textarea.style.border = 'none';
    textarea.style.backgroundColor = '#ffffff';
    textarea.style.outline = 'none';
    textarea.style.padding = '4px';
    return textarea;
  }

  function insertPastedDataToTable(text) {
    if (!text) return;

    const rows = text.trim().split(/\r?\n/).map(row => row.split('\t'));

    const colCount = Math.max(...rows.map(r => r.length));
    const currentCols = table.rows[0]?.cells.length || 0;
    const totalCols = Math.max(currentCols, colCount);

    for (let r = 0; r < rows.length; r++) {
      const tr = document.createElement('tr');
      for (let c = 0; c < totalCols; c++) {
        const td = document.createElement('td');
        const ta = createStyledTextarea(rows[r][c] || '');
        autoResizeTextarea(ta);
        td.appendChild(ta);
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
  }



  // Xá»­ lÃ½ má»Ÿ popup dÃ¡n dá»¯ liá»‡u
  pasteBtn.onclick = () => {
    pasteTextarea.value = '';
    pasteModal.style.display = 'flex';
    pasteTextarea.focus();
  };

  // Huá»· popup
  pasteCancelBtn.onclick = () => {
    pasteModal.style.display = 'none';
  };

  // XÃ¡c nháº­n dÃ¡n dá»¯ liá»‡u
  pasteConfirmBtn.onclick = () => {
    const text = pasteTextarea.value;
    insertPastedDataToTable(text);
    pasteModal.style.display = 'none';
  };


  const table = document.createElement('table');
  table.className = 'editable-table resizable';
  Object.assign(table.style, {
    width: '100%',
    tableLayout: 'auto',
    borderCollapse: 'collapse',
    marginTop: '10px'
  });
  

  function syncRowHeight(tr) {
    let maxHeight = 0;
    const textareas = tr.querySelectorAll('textarea');
    textareas.forEach(ta => {
      ta.style.height = 'auto';
      const h = ta.scrollHeight;
      if (h > maxHeight) maxHeight = h;
    });
    textareas.forEach(ta => {
      ta.style.height = maxHeight + 'px';
    });
  }

  function createTable(rows, cols) {
    table.innerHTML = '';
    for (let r = 0; r < rows; r++) {
      const tr = document.createElement('tr');
      for (let c = 0; c < cols; c++) {
        const td = document.createElement('td');
        td.style.border = '1px solid #ccc';
        td.style.padding = '4px';

        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'table-cell-wrapper';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'table-cell-checkbox';
        checkbox.style.position = 'absolute';
        checkbox.style.top = '0px';
        checkbox.style.right = '0px';           // âœ… Äáº·t bÃªn pháº£i thay vÃ¬ dÃ¹ng left
        checkbox.style.width = '30px';          // Tuá»³ chá»‰nh kÃ­ch thÆ°á»›c
        checkbox.style.height = '14px';
        checkbox.style.zIndex = '1';
        checkbox.style.display = 'none';



        const textarea = document.createElement('textarea');
          textarea.rows = 1;
          textarea.style.width = '100%';
          textarea.style.resize = 'none';
          textarea.style.fontFamily = 'inherit';
          textarea.style.border = 'none';
          textarea.style.backgroundColor = '#ffffff';
        
        textarea.addEventListener('input', () => {
          autoResizeTextarea(textarea);
          syncRowHeight(tr);
        });

        autoResizeTextarea(textarea);

        wrapperDiv.appendChild(checkbox);
        wrapperDiv.appendChild(textarea);
        td.appendChild(wrapperDiv);
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    makeColumnsResizable(table);
  }

  function makeColumnsResizable(table) {
    const firstRow = table.rows[0];
    if (!firstRow) return;

    for (let cell of firstRow.cells) {
      const wrapper = cell.querySelector('.table-cell-wrapper');
      if (!wrapper) continue;

      const resizer = document.createElement('div');
      resizer.style.width = '5px';
      resizer.style.height = '100%';
      resizer.style.position = 'absolute';
      resizer.style.top = '0';
      resizer.style.right = '0';
      resizer.style.cursor = 'col-resize';
      resizer.style.userSelect = 'none';
      resizer.style.zIndex = '10';

      wrapper.style.position = 'relative'; // Ä‘áº£m báº£o chá»©a Ä‘Æ°á»£c resizer
      wrapper.appendChild(resizer);

      let startX, startWidth;

      resizer.addEventListener('mousedown', function (e) {
        startX = e.pageX;
        startWidth = cell.offsetWidth;

        function onMouseMove(e) {
          const newWidth = startWidth + (e.pageX - startX);
          cell.style.width = newWidth + 'px';
        }

        function onMouseUp() {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    }
  }


  createBtn.onclick = () => {
    const rows = parseInt(rowsInput.value);
    const cols = parseInt(colsInput.value);
    if (rows > 0 && cols > 0) {
      createTable(rows, cols);
    } else {
      alert('Sá»‘ hÃ ng vÃ  sá»‘ cá»™t pháº£i lá»›n hÆ¡n 0');
    }
  };

  

  let isSelecting = false;

  selectBtn.onclick = () => {
    isSelecting = true;
    selectBtn.style.display = 'none';
    confirmMergeBtn.style.display = 'inline-block';
    cancelMergeBtn.style.display = 'inline-block';

    const checkboxes = table.querySelectorAll('.table-cell-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = false;
      cb.style.display = 'block';
    });
  };

  cancelMergeBtn.onclick = () => {
    isSelecting = false;
    selectBtn.style.display = 'inline-block';
    confirmMergeBtn.style.display = 'none';
    cancelMergeBtn.style.display = 'none';

    const checkboxes = table.querySelectorAll('.table-cell-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = false;
      cb.style.display = 'none';
    });
  };

  addRowBtn.onclick = () => {
    const cols = table.rows[0]?.cells.length || 1;
    const tr = document.createElement('tr');

    for (let c = 0; c < cols; c++) {
      const td = document.createElement('td');
      td.style.border = '1px solid #ccc';
      td.style.padding = '4px';

      const wrapperDiv = document.createElement('div');
      wrapperDiv.className = 'table-cell-wrapper';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'table-cell-checkbox';
      checkbox.style.position = 'absolute';
      checkbox.style.top = '0px';
      checkbox.style.right = '0px';
      checkbox.style.width = '30px';
      checkbox.style.height = '14px';
      checkbox.style.zIndex = '1';
      checkbox.style.display = 'none';

      const textarea = document.createElement('textarea');
      textarea.rows = 1;
      textarea.style.width = '100%';
      textarea.style.resize = 'none';
      textarea.style.fontFamily = 'inherit';
      textarea.style.border ='none';
      textarea.style.backgroundColor = '#ffffff';
      textarea.addEventListener('input', () => {
        autoResizeTextarea(textarea);
        syncRowHeight(tr);
      });

      autoResizeTextarea(textarea);

      wrapperDiv.appendChild(checkbox);
      wrapperDiv.appendChild(textarea);
      td.appendChild(wrapperDiv);
      tr.appendChild(td);
    }

    table.appendChild(tr);
    
  };


  // HÃ m tÃ­nh vá»‹ trÃ­ cá»™t "áº£o" dá»±a trÃªn colSpan cá»§a cÃ¡c Ã´ trong 1 hÃ ng
  function getCellsPositionsInRow(row) {
    const positions = [];
    let colPos = 0;
    for (const cell of row.cells) {
      positions.push({ cell, startCol: colPos, colSpan: cell.colSpan || 1 });
      colPos += cell.colSpan || 1;
    }
    return positions;
  }

  // HÃ m kiá»ƒm tra cÃ¡c Ã´ cÃ³ liá»n ká» trong 1 hÃ ng khÃ´ng
  function areCellsContiguousInRow(row, selectedCells) {
    const positions = getCellsPositionsInRow(row);

    const selectedPositions = positions.filter(p => selectedCells.includes(p.cell));

    // Sáº¯p xáº¿p theo vá»‹ trÃ­ cá»™t áº£o
    selectedPositions.sort((a, b) => a.startCol - b.startCol);

    for (let i = 1; i < selectedPositions.length; i++) {
      const prev = selectedPositions[i - 1];
      const curr = selectedPositions[i];
      if (prev.startCol + prev.colSpan !== curr.startCol) {
        return false;
      }
    }
    return true;
  }

  // HÃ m tÃ­nh vá»‹ trÃ­ hÃ ng "áº£o" dá»±a trÃªn rowSpan cá»§a cÃ¡c Ã´ trong 1 cá»™t
  function getCellsPositionsInCol(table, colIndex) {
    const positions = [];
    let rowPos = 0;
    for (let r = 0; r < table.rows.length; r++) {
      const row = table.rows[r];
      let colCount = 0;
      for (const cell of row.cells) {
        const colSpan = cell.colSpan || 1;
        const rowSpan = cell.rowSpan || 1;
        if (colCount === colIndex) {
          positions.push({ cell, startRow: rowPos, rowSpan });
          break;
        }
        colCount += colSpan;
      }
      rowPos++;
    }
    return positions;
  }

  // Kiá»ƒm tra cÃ¡c Ã´ cÃ³ liá»n ká» trong 1 cá»™t khÃ´ng
  function areCellsContiguousInCol(table, colIndex, selectedCells) {
    const positions = getCellsPositionsInCol(table, colIndex);

    const selectedPositions = positions.filter(p => selectedCells.includes(p.cell));

    // Sáº¯p xáº¿p theo vá»‹ trÃ­ hÃ ng áº£o
    selectedPositions.sort((a, b) => a.startRow - b.startRow);

    for (let i = 1; i < selectedPositions.length; i++) {
      const prev = selectedPositions[i - 1];
      const curr = selectedPositions[i];
      if (prev.startRow + prev.rowSpan !== curr.startRow) {
        return false;
      }
    }
    return true;
  }

  // HÃ m táº¡o ma tráº­n 2D báº£ng (dÃ¹ng cho vá»‹ trÃ­ thá»±c táº¿ cá»§a cÃ¡c Ã´, há»— trá»£ rowspan/colspan)
function buildTableMatrix(table) {
  const matrix = [];
  const rows = table.rows.length;
  for (let r = 0; r < rows; r++) matrix[r] = [];
  for (let r = 0; r < rows; r++) {
    const row = table.rows[r];
    let colPos = 0;
    for (let c = 0; c < row.cells.length; c++) {
      const cell = row.cells[c];
      const rowSpan = cell.rowSpan || 1;
      const colSpan = cell.colSpan || 1;

      // TÃ¬m vá»‹ trÃ­ trá»‘ng Ä‘áº§u tiÃªn trÃªn hÃ ng r
      while (matrix[r][colPos]) colPos++;

      // ÄÃ¡nh dáº¥u cell chiáº¿m vá»‹ trÃ­ (r..r+rowSpan, colPos..colPos+colSpan)
      for (let rs = 0; rs < rowSpan; rs++) {
        for (let cs = 0; cs < colSpan; cs++) {
          matrix[r + rs][colPos + cs] = cell;
        }
      }

      colPos += colSpan;
    }
  }
  return matrix;
}

// HÃ m láº¥y vá»‹ trÃ­ (row, col) thá»±c táº¿ cá»§a cÃ¡c Ã´ Ä‘Æ°á»£c chá»n
function getSelectedCellsPositions(table, selectedCells) {
  const matrix = buildTableMatrix(table);
  const positions = [];
  for (let r = 0; r < matrix.length; r++) {
    for (let c = 0; c < matrix[r].length; c++) {
      const cell = matrix[r][c];
      if (selectedCells.includes(cell)) {
        if (!positions.find(p => p.cell === cell)) {
          positions.push({ cell, rowIndex: r, colIndex: c });
        }
      }
    }
  }
  return positions;
}

// Kiá»ƒm tra cÃ¡c Ã´ cÃ³ liá»n ká» trong cÃ¹ng hÃ ng
function areCellsContiguousInRow(positions) {
  const row = positions[0].rowIndex;
  if (!positions.every(p => p.rowIndex === row)) return false;

  const cols = positions.map(p => p.colIndex).sort((a, b) => a - b);

  for (let i = 1; i < cols.length; i++) {
    if (cols[i] !== cols[i - 1] + 1) return false;
  }
  return true;
}

// Kiá»ƒm tra cÃ¡c Ã´ cÃ³ liá»n ká» trong cÃ¹ng cá»™t
function areCellsContiguousInCol(positions) {
  const col = positions[0].colIndex;
  if (!positions.every(p => p.colIndex === col)) return false;

  const rows = positions.map(p => p.rowIndex).sort((a, b) => a - b);

  for (let i = 1; i < rows.length; i++) {
    if (rows[i] !== rows[i - 1] + 1) return false;
  }
  return true;
}

// HÃ m gá»™p Ã´ Ä‘Æ°á»£c chá»n, dÃ¹ng ma tráº­n vá»‹ trÃ­ chÃ­nh xÃ¡c vÃ  set colSpan/rowSpan + width/height
confirmMergeBtn.onclick = () => {
  const checkboxes = table.querySelectorAll('.table-cell-checkbox:checked');
  const selectedCells = Array.from(checkboxes).map(cb => cb.closest('td'));

  if (selectedCells.length <= 1) {
    alert('Chá»n Ã­t nháº¥t 2 Ã´ Ä‘á»ƒ gá»™p');
    return;
  }

  const positions = getSelectedCellsPositions(table, selectedCells);

  const sameRow = positions.every(p => p.rowIndex === positions[0].rowIndex);
  const sameCol = positions.every(p => p.colIndex === positions[0].colIndex);

  if (!sameRow && !sameCol) {
    alert('Chá»‰ cÃ³ thá»ƒ gá»™p cÃ¡c Ã´ cÃ¹ng hÃ ng hoáº·c cÃ¹ng cá»™t!');
    return;
  }

  if (sameRow) {
    if (!areCellsContiguousInRow(positions)) {
      alert('CÃ¡c Ã´ trong cÃ¹ng hÃ ng pháº£i liá»n ká» Ä‘á»ƒ gá»™p');
      return;
    }

    positions.sort((a, b) => a.colIndex - b.colIndex);

    const main = positions[0].cell;
    let content = '';

    positions.forEach((pos, idx) => {
      const ta = pos.cell.querySelector('textarea');
      if (ta && ta.value.trim()) content += (idx === 0 ? '' : '\n') + ta.value;
      if (idx > 0) pos.cell.remove();
    });

    const taMain = main.querySelector('textarea');
    taMain.value = content;

    main.colSpan = positions.length;
    main.style.width = ''; // Bá» set width thá»§ cÃ´ng, Ä‘á»ƒ trÃ¬nh duyá»‡t tá»± tÃ­nh
    main.style.height = ''; // Reset chiá»u cao náº¿u cÃ³
    main.rowSpan = 1;
  }
 else if (sameCol) {
  if (!areCellsContiguousInCol(positions)) {
    alert('CÃ¡c Ã´ trong cÃ¹ng cá»™t pháº£i liá»n ká» Ä‘á»ƒ gá»™p');
    return;
  }

  positions.sort((a, b) => a.rowIndex - b.rowIndex);

  const main = positions[0].cell;
  let content = '';

  positions.forEach((pos, idx) => {
    const ta = pos.cell.querySelector('textarea');
    if (ta && ta.value.trim()) content += (idx === 0 ? '' : '\n') + ta.value;
    if (idx > 0) pos.cell.remove();
  });

  const taMain = main.querySelector('textarea');
  taMain.value = content;

  main.rowSpan = positions.length;
  main.colSpan = 1;
  main.style.width = ''; // reset chiá»u rá»™ng náº¿u cÃ³

  // TÃ­nh chiá»u cao 1 Ã´ chuáº©n (rowSpan=1) á»Ÿ cá»™t gá»™p
  let singleCellHeight = 0;
  const colIndex = positions[0].colIndex;
  for (let r = 0; r < table.rows.length; r++) {
    let colCount = 0;
    const row = table.rows[r];
    for (const cell of row.cells) {
      if (colCount === colIndex && (cell.rowSpan || 1) === 1) {
        singleCellHeight = cell.getBoundingClientRect().height;
        break;
      }
      colCount += cell.colSpan || 1;
    }
    if (singleCellHeight) break;
  }

  if (singleCellHeight) {
    main.style.height = (singleCellHeight * positions.length) + 'px';
  } else {
    main.style.height = '';
  }
}


  // Reset láº¡i tráº¡ng thÃ¡i chá»n vÃ  áº©n checkbox
  isSelecting = false;
  selectBtn.style.display = 'inline-block';
  confirmMergeBtn.style.display = 'none';
  cancelMergeBtn.style.display = 'none';

  const allCheckboxes = table.querySelectorAll('.table-cell-checkbox');
  allCheckboxes.forEach(cb => {
    cb.checked = false;
    cb.style.display = 'none';
  });
};



  wrapper.appendChild(title);
  wrapper.appendChild(config);
  wrapper.appendChild(table);
  wrapper.appendChild(tableFooter);
  container.appendChild(wrapper);
}



// ThÃªm Ã´ ná»™i dung phá»¥ (textarea) trong má»¥c con
function addExtraContent(button, containerOverride, level = 1) {
  const container = containerOverride || button.closest('.report-pvt-create__group').querySelector('.report-section__children');

  const wrapper = document.createElement('div');
  wrapper.className = 'report-subitem-extra';

  wrapper.style.backgroundColor = '#ffffff';
  wrapper.style.marginBottom = '10px';

  const textarea = document.createElement('textarea');
  textarea.placeholder = 'Ná»™i dung';
  textarea.rows = 2;
  textarea.style.width = '100%';
  textarea.style.resize = 'vertical';
  textarea.addEventListener('input', () => autoResizeTextarea(textarea));
  autoResizeTextarea(textarea);

  const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'âŒ XoÃ¡ ná»™i dung';

    Object.assign(removeBtn.style, {
      position: 'static',
      display: 'block',
      background: '#e94e4e',
      border: 'none',
      color: 'white',
      fontWeight: '700',
      padding: '8px 18px',
      borderRadius: '6px',
      cursor: 'pointer',
      fontSize: '1rem',
      boxShadow: '0 0 5px rgba(233, 78, 78, 0.666)',
      transition: 'background-color 0.3s ease',
      marginTop: '5px',
      userSelect: 'none',
      width: 'max-content'
    });
  
  const removeBtnWrapper = document.createElement('div');
    removeBtnWrapper.style.flexDirection = 'row-reverse';  
    removeBtnWrapper.style.display = 'flex'; 
    removeBtnWrapper.appendChild(removeBtn);

  removeBtn.onmouseenter = () => removeBtn.style.background = '#c43c3c';
  removeBtn.onmouseleave = () => removeBtn.style.background = '#e94e4e';

  removeBtn.onclick = () => {
    if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xoÃ¡ ná»™i dung nÃ y khÃ´ng?')) {
      wrapper.remove();
    }
  };

  wrapper.appendChild(textarea);
  wrapper.appendChild(removeBtnWrapper);
  container.appendChild(wrapper);
}

function collectTableData(tableEl) {
  const rows = tableEl?.rows || [];
  const matrix = []; // ma tráº­n 2D Ä‘Ã¡nh dáº¥u Ã´ Ä‘Ã£ láº¥y

  const cellsData = [];

  for (let r = 0; r < rows.length; r++) {
    const row = rows[r];
    let colIndex = 0;

    cellsData[r] = [];

    for (let c = 0; c < row.cells.length; c++) {
      // TÃ¬m colIndex trá»‘ng tiáº¿p theo trong ma tráº­n
      while (matrix[r] && matrix[r][colIndex]) {
        colIndex++;
      }

      const cell = row.cells[c];
      const textarea = cell.querySelector('textarea');

      const rowSpan = cell.rowSpan || 1;
      const colSpan = cell.colSpan || 1;

      // Chá»‰ láº¥y Ã´ gá»‘c (Ã´ Ä‘áº§u tiÃªn trong vÃ¹ng gá»™p)
      cellsData[r][colIndex] = {
        text: textarea ? textarea.value.trim() : '',
        rowSpan,
        colSpan
      };

      // ÄÃ¡nh dáº¥u cÃ¡c Ã´ trong vÃ¹ng gá»™p trong ma tráº­n Ä‘á»ƒ bá» qua sau
      for (let rs = 0; rs < rowSpan; rs++) {
        for (let cs = 0; cs < colSpan; cs++) {
          if (!matrix[r + rs]) matrix[r + rs] = [];
          matrix[r + rs][colIndex + cs] = true;
        }
      }

      colIndex += colSpan;
    }
  }

  return cellsData;
}


  // Thu tháº­p dá»¯ liá»‡u Ä‘á»‡ quy má»¥c con + báº£ng, Ä‘Ãºng thá»© tá»±
// Thu tháº­p dá»¯ liá»‡u Ä‘á»‡ quy má»¥c con + báº£ng, Ä‘Ãºng thá»© tá»±
function collectSectionData(section) {
  const group = document.querySelector(`[data-section="${section}"]`);
  if (!group) return [];

  const container = group.querySelector('.report-section__children');
  if (!container) return [];

  const results = [];

  Array.from(container.children).forEach(child => {
    if (child.classList.contains('report-subitem')) {
      const textarea = child.querySelector('textarea');
      const content = textarea?.value.trim() || '';
      const subContainer = child.querySelector('.report-section__children');
      const children = subContainer ? collectSectionChildren(subContainer) : [];
      results.push({ type: 'subitem', title: content, children });
    }

    else if (child.classList.contains('report-subitem-extra')) {
      const textarea = child.querySelector('textarea');
      const content = textarea?.value.trim() || '';
      results.push({ type: 'text', content });
    }

    else if (child.classList.contains('report-subtable')) {
      const title = child.querySelector('textarea')?.value.trim() || '';
      const tableEl = child.querySelector('table');
      const cells = collectTableData(tableEl);
      results.push({ type: 'table', title, cells });
    }
  });

  return results;
}

function collectSectionChildren(container) {
  const results = [];

  Array.from(container.children).forEach(child => {
    if (child.classList.contains('report-subitem')) {
      const textarea = child.querySelector('textarea');
      const content = textarea?.value.trim() || '';
      const subContainer = child.querySelector('.report-section__children');
      const children = subContainer ? collectSectionChildren(subContainer) : [];
      results.push({ type: 'text', content, children });
    }

    else if (child.classList.contains('report-subitem-extra')) {
      const textarea = child.querySelector('textarea');
      const content = textarea?.value.trim() || '';
      results.push({ type: 'text', content });
    }

    else if (child.classList.contains('report-subtable')) {
      const title = child.querySelector('textarea')?.value.trim() || '';
      const tableEl = child.querySelector('table');
      const cells = collectTableData(tableEl);
      results.push({ type: 'table', title, cells });
    }
  });

  return results;
}


async function loadReportDataFromTemplate() {
  try {
    const res = await fetch('/json/template-report.json');
    if (!res.ok) throw new Error('KhÃ´ng thá»ƒ táº£i máº«u bÃ¡o cÃ¡o');

    const data = await res.json();  // Dá»¯ liá»‡u tá»« JSON

    // Äiá»n thÃ´ng tin chung
    document.querySelector('[name="reportName"]').value = data.reportName || '';
    document.querySelector('[name="number"]').value = data.number || '';
    document.querySelector('[name="recipient"]').value = data.recipient || '';   
    document.querySelector('[name="receivers"]').value = data.receivers || '';
    document.querySelector('[name="signer"]').value = data.signer || '';
    document.querySelector('[name="position"]').value = data.position || '';

    // Render cÃ¡c pháº§n ná»™i dung
    for (const sectionName in data.sections) {
      const items = data.sections[sectionName];
      const container = document.querySelector(`[data-section="${sectionName}"] .report-section__children`);
      if (container) {
        renderSectionItems(container, items);
      }
    }

  } catch (error) {
    console.error('Lá»—i khi táº£i máº«u bÃ¡o cÃ¡o:', error);
  }
}


function makeColumnsResizable(table) {
  const firstRow = table.rows[0];
  if (!firstRow) return;

  for (let cell of firstRow.cells) {
    cell.style.position = 'relative'; // Äáº£m báº£o position relative

    const resizer = document.createElement('div');
    resizer.style.width = '5px';
    resizer.style.height = '100%';
    resizer.style.position = 'absolute';
    resizer.style.top = '0';
    resizer.style.right = '0';
    resizer.style.cursor = 'col-resize';
    resizer.style.userSelect = 'none';
    resizer.style.zIndex = '10';

    cell.appendChild(resizer);

    let startX, startWidth;

    resizer.addEventListener('mousedown', function (e) {
      e.preventDefault();
      startX = e.pageX;
      startWidth = cell.offsetWidth;

      function onMouseMove(e) {
        const newWidth = startWidth + (e.pageX - startX);
        if (newWidth > 30) { // Äáº·t min width trÃ¡nh quÃ¡ nhá»
          cell.style.width = newWidth + 'px';
        }
      }

      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  }
}


function renderSectionItems(container, items) {
  container.innerHTML = ''; // XoÃ¡ cÅ©

  items.forEach(item => {
    if (item.type === 'subitem') {
      // Render má»¥c con cÃ³ title + children
      const wrapper = document.createElement('div');
      wrapper.className = 'report-subitem';
      Object.assign(wrapper.style, {
        marginBottom: '10px',
        border: '1px solid #ccc',
        padding: '10px',
        borderRadius: '8px',
        backgroundColor: '#ffffff',
      });

      // TiÃªu Ä‘á» má»¥c con (textarea)
      const title = document.createElement('textarea');
      title.rows = 1;
      title.value = item.title || '';
      title.placeholder = 'TiÃªu Ä‘á» má»¥c con';
      Object.assign(title.style, {
        width: '100%',
        marginBottom: '6px',
        fontWeight: '600',
        backgroundColor: '#ffffff',
        border: '1px solid #ccc',
        borderRadius: '4px',
        padding: '4px 8px',
        boxSizing: 'border-box',
        resize: 'none',
      });
      title.addEventListener('input', () => autoResizeTextarea(title));
      autoResizeTextarea(title);

      // Container chá»©a cÃ¡c pháº§n tá»­ con (children)
      const childrenContainer = document.createElement('div');
      childrenContainer.className = 'report-section__children';
      Object.assign(childrenContainer.style, {
        marginTop: '10px',
        borderLeft: '2px dashed #aaa',
        paddingLeft: '10px',
        backgroundColor: '#fafafa',
      });

      // Äá»‡ quy render children
      if (item.children && item.children.length) {
        renderSectionItems(childrenContainer, item.children);
      }

      // NÃºt chá»©c nÄƒng
      const buttonGroup = document.createElement('div');
      Object.assign(buttonGroup.style, {
        display: 'flex',
        justifyContent: 'space-between',
        gap: '10px',
        marginTop: '10px',
      });

      // ThÃªm ná»™i dung con (text)
      const addExtraBtn = document.createElement('button');
      addExtraBtn.type = 'button';
      addExtraBtn.textContent = 'â• ThÃªm ná»™i dung';
      Object.assign(addExtraBtn.style, {
        backgroundColor: '#007acc',
        color: '#fff',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });
      addExtraBtn.onmouseenter = () => (addExtraBtn.style.backgroundColor = '#005fa3');
      addExtraBtn.onmouseleave = () => (addExtraBtn.style.backgroundColor = '#007acc');
      addExtraBtn.onclick = () => addExtraContent(addExtraBtn, childrenContainer);

      // ThÃªm báº£ng
      const addTableBtn = document.createElement('button');
      addTableBtn.type = 'button';
      addTableBtn.textContent = 'ğŸ“Š ThÃªm báº£ng';
      Object.assign(addTableBtn.style, {
        backgroundColor: '#007acc',
        color: '#fff',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });
      addTableBtn.onmouseenter = () => (addTableBtn.style.backgroundColor = '#005fa3');
      addTableBtn.onmouseleave = () => (addTableBtn.style.backgroundColor = '#007acc');
      addTableBtn.onclick = () => addTable(addTableBtn, null, childrenContainer);

      // XoÃ¡ má»¥c con
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = 'âŒ XoÃ¡ má»¥c ';
      Object.assign(removeBtn.style, {
        backgroundColor: '#e94e4e',
        color: 'white',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });
      removeBtn.onmouseenter = () => (removeBtn.style.backgroundColor = '#c43c3c');
      removeBtn.onmouseleave = () => (removeBtn.style.backgroundColor = '#e94e4e');
      removeBtn.onclick = () => {
        if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xoÃ¡ má»¥c nÃ y khÃ´ng?')) {
          wrapper.remove();
        }
      };

      buttonGroup.appendChild(addExtraBtn);
      buttonGroup.appendChild(addTableBtn);
      buttonGroup.appendChild(removeBtn);

      wrapper.appendChild(title);
      wrapper.appendChild(childrenContainer);
      wrapper.appendChild(buttonGroup);
      container.appendChild(wrapper);
    }
    if (item.type === 'text') {
      const wrapper = document.createElement('div');
      wrapper.className = 'report-subitem-extra';  
      Object.assign(wrapper.style, {
        marginBottom: '10px',
        border: '1px solid #ccc',
        borderRadius: '8px',
        padding: '10px',
        backgroundColor: '#ffffff',
      });

      const textarea = document.createElement('textarea');
      textarea.rows = 2;
      textarea.value = item.content || '';
      textarea.addEventListener('input', () => autoResizeTextarea(textarea));
      textarea.style.transition = 'height 0.2s ease';
      requestAnimationFrame(() => autoResizeTextarea(textarea));



      textarea.value = item.content || '';
      textarea.placeholder = 'Ná»™i dung';
      Object.assign(textarea.style, {
        width: '100%',
        border: '1px solid #ccc',
        borderRadius: '4px',
        padding: '4px 8px',
        boxSizing: 'border-box',
        resize: 'none',
        fontFamily: 'inherit',
      });
      textarea.addEventListener('input', () => autoResizeTextarea(textarea));
      autoResizeTextarea(textarea);

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = 'âŒ XoÃ¡ ná»™i dung';
      Object.assign(removeBtn.style, {
        backgroundColor: '#e94e4e',
        color: 'white',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });
      removeBtn.onmouseenter = () => (removeBtn.style.backgroundColor = '#c43c3c');
      removeBtn.onmouseleave = () => (removeBtn.style.backgroundColor = '#e94e4e');
      removeBtn.onclick = () => {
        if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xoÃ¡ ná»™i dung nÃ y khÃ´ng?')) {
          wrapper.remove();
        }
      };

      // Bá»c nÃºt xÃ³a trong div cÄƒn sang pháº£i
      const removeBtnWrapper = document.createElement('div');
      removeBtnWrapper.style.display = 'flex';
      removeBtnWrapper.style.justifyContent = 'flex-end';
      removeBtnWrapper.style.marginTop = '5px';
      removeBtnWrapper.appendChild(removeBtn);

      wrapper.appendChild(textarea);
      wrapper.appendChild(removeBtnWrapper);
      container.appendChild(wrapper);
    }

    else if (item.type === 'table') {
      const wrapper = document.createElement('div');
      wrapper.className = 'report-subtable';
      wrapper.style.overflowX = 'auto'; // trÃ¡nh báº£ng bá»‹ trÃ n

      const title = document.createElement('textarea');
      title.rows = 1;
      title.value = item.title || '';
      title.placeholder = 'TiÃªu Ä‘á» báº£ng';
      Object.assign(title.style, {
        width: '100%',
        marginBottom: '10px',
        fontWeight: '600',
        backgroundColor: '#ffffff',
        border: '1px solid #ccc',
        borderRadius: '4px',
        padding: '4px 8px',
        boxSizing: 'border-box',
        resize: 'none',
      });
      title.addEventListener('input', () => autoResizeTextarea(title));
      autoResizeTextarea(title);

      const table = document.createElement('table');
      table.className = 'editable-table resizable';
      Object.assign(table.style, {
        width: '100',
        maxWidth: '100%',
        tableLayout: 'auto',
        borderCollapse: 'collapse',
      });

      const cells = item.cells || [];
      for (let r = 0; r < cells.length; r++) {
        const row = document.createElement('tr');
        for (let c = 0; c < cells[r].length; c++) {
          const cellData = cells[r][c];
          if (!cellData) continue;

          const td = document.createElement('td');
          td.rowSpan = cellData.rowSpan || 1;
          td.colSpan = cellData.colSpan || 1;
          td.style.border = '1px solid #ccc';
          td.style.padding = '4px';
          td.style.position = 'relative'; // Ä‘á»ƒ chá»©a resizer

          const wrapperDiv = document.createElement('div');
          wrapperDiv.className = 'table-cell-wrapper';
          Object.assign(wrapperDiv.style, {
            position: 'relative',
            width: '100%',
            height: '100%',
            boxSizing: 'border-box',
          });

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'table-cell-checkbox';
          Object.assign(checkbox.style, {
            position: 'absolute',
            top: '0px',
            right: '0px',
            width: '30px',
            height: '14px',
            zIndex: '1',
            display: 'none',
          });

          const textarea = document.createElement('textarea');
          textarea.rows = 1;
          textarea.value = cellData.text || '';
          Object.assign(textarea.style, {
            minHeight: '30px',
            border: 'none',
            resize: 'none',
            padding: '4px 6px',
            fontFamily: 'inherit',
            backgroundColor: '#ffffff',
            boxSizing: 'border-box',
            overflow: 'hidden',
          });

          textarea.addEventListener('input', () => autoResizeTextarea(textarea));
          requestAnimationFrame(() => autoResizeTextarea(textarea));

          wrapperDiv.appendChild(checkbox);
          wrapperDiv.appendChild(textarea);
          td.appendChild(wrapperDiv);
          row.appendChild(td);
        }
        table.appendChild(row);
      }


      const pasteBtn = document.createElement('button');
      pasteBtn.type = 'button';
      pasteBtn.textContent = 'ğŸ“‹ DÃ¡n dá»¯ liá»‡u';
      Object.assign(pasteBtn.style, {
        backgroundColor: '#6f42c1',
        color: 'white',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });

            // Táº¡o modal dÃ¡n dá»¯ liá»‡u (chá»‰ táº¡o má»™t láº§n)
      const pasteModal = document.createElement('div');
      Object.assign(pasteModal.style, {
        position: 'fixed',
        top: '0',
        left: '0',
        width: '100vw',
        height: '100vh',
        backgroundColor: 'rgba(0, 0, 0, 0.5)',
        display: 'none',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: '1000'
      });

      const pasteBox = document.createElement('div');
      Object.assign(pasteBox.style, {
        backgroundColor: 'white',
        padding: '20px',
        borderRadius: '8px',
        width: '500px',
        maxWidth: '90%',
        display: 'flex',
        flexDirection: 'column',
      });


      const pasteTextarea = document.createElement('textarea');
      pasteTextarea.placeholder = 'DÃ¡n dá»¯ liá»‡u tá»« Excel hoáº·c báº£ng...';
      Object.assign(pasteTextarea.style, {
        width: '100%',
        height: '150px',
        marginBottom: '10px',
        resize: 'vertical'
      });

      const pasteButtons = document.createElement('div');
      Object.assign(pasteButtons.style, {
        display: 'flex',
        justifyContent: 'flex-end',
        gap: '10px'
      });

      const pasteConfirmBtn = document.createElement('button');
      pasteConfirmBtn.textContent = 'Nháº­p dá»¯ liá»‡u vÃ o báº£ng';
      Object.assign(pasteConfirmBtn.style, {
        backgroundColor: '#28a745',
        color: 'white',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });

      const pasteCancelBtn = document.createElement('button');
      pasteCancelBtn.type = 'button';
      pasteCancelBtn.textContent = 'Huá»·';
      Object.assign(pasteCancelBtn.style, {
        backgroundColor: '#dc3545',
        color: 'white',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });

      // Äáº£m báº£o thá»© tá»± há»£p lÃ½: Huá»· bÃªn trÃ¡i, Nháº­p bÃªn pháº£i
      pasteButtons.appendChild(pasteCancelBtn);
      pasteButtons.appendChild(pasteConfirmBtn);


      pasteBox.appendChild(pasteTextarea);
      pasteBox.appendChild(pasteButtons);
      pasteModal.appendChild(pasteBox);
      document.body.appendChild(pasteModal);

      // Xá»­ lÃ½ má»Ÿ popup
      pasteBtn.onclick = () => {
        pasteTextarea.value = '';
        pasteModal.style.display = 'flex';
        pasteTextarea.focus();
      };

      // Huá»· popup
      pasteCancelBtn.onclick = () => {
        pasteModal.style.display = 'none';
      };

      // HÃ m dÃ¡n dá»¯ liá»‡u vÃ o báº£ng
      function insertPastedDataToTable(text, table) {
        if (!text) return;

        const rows = text.trim().split(/\r?\n/).map(row => row.split('\t'));

        // Láº¥y sá»‘ cá»™t tá»« hÃ ng cuá»‘i cÃ¹ng hiá»‡n cÃ³ cá»§a báº£ng
        const lastRow = table.rows[table.rows.length - 1];
        const currentCols = lastRow 
          ? Array.from(lastRow.cells).reduce((sum, cell) => sum + (parseInt(cell.colSpan) || 1), 0)
          : 0;

        const colCount = Math.max(...rows.map(r => r.length));
        const totalCols = Math.max(currentCols, colCount);

        rows.forEach(dataRow => {
          const tr = document.createElement('tr');

          for (let c = 0; c < totalCols; c++) {
            const td = document.createElement('td');

            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'table-cell-wrapper';
            wrapperDiv.style.position = 'relative';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'table-cell-checkbox';
            Object.assign(checkbox.style, {
              position: 'absolute',
              top: '0px',
              right: '0px',
              width: '30px',
              height: '14px',
              zIndex: '1',
              display: 'none',
            });

            const textarea = document.createElement('textarea');
            textarea.rows = 1;
            textarea.value = dataRow[c] || '';
            Object.assign(textarea.style, {
              width: '100%',
              height: '100%',
              border: 'none',
              resize: 'none',
              padding: '6px',
              boxSizing: 'border-box',
              fontFamily: 'inherit',
              backgroundColor: '#ffffff',
            });

            textarea.addEventListener('input', () => autoResizeTextarea(textarea));
            requestAnimationFrame(() => autoResizeTextarea(textarea));

            wrapperDiv.appendChild(checkbox);
            wrapperDiv.appendChild(textarea);
            td.appendChild(wrapperDiv);
            tr.appendChild(td);
          }

          table.appendChild(tr);
        });
      }


      // XÃ¡c nháº­n dÃ¡n dá»¯ liá»‡u
      pasteConfirmBtn.onclick = () => {
        insertPastedDataToTable(pasteTextarea.value, table);
        pasteModal.style.display = 'none';
      };


      const deleteTableBtn = document.createElement('button');
      deleteTableBtn.type = 'button';
      deleteTableBtn.textContent = 'âŒ XoÃ¡ báº£ng';
      Object.assign(deleteTableBtn.style, {
        backgroundColor: '#e94e4e',
        color: 'white',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });

      deleteTableBtn.onclick = () => {
        if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xoÃ¡ báº£ng nÃ y khÃ´ng?')) {
          wrapper.remove();
        }
      };

      const addRowBtn = document.createElement('button');
        addRowBtn.type = 'button';
        addRowBtn.textContent = 'â• ThÃªm hÃ ng';
        Object.assign(addRowBtn.style, {
          backgroundColor: '#17a2b8',
          color: 'white',
          border: 'none',
          padding: '6px 12px',
          borderRadius: '5px',
          cursor: 'pointer',
          fontWeight: '600',
        });
        
        addRowBtn.onclick = () => {
          const newRow = document.createElement('tr');

          // Náº¿u cÃ³ dÃ²ng nÃ o rá»“i thÃ¬ táº¡o sá»‘ cá»™t báº±ng dÃ²ng Ä‘áº§u tiÃªn
          const lastRow = table.rows[table.rows.length - 1];
          const numCols = Array.from(lastRow?.cells || []).reduce((sum, cell) => {
            return sum + (parseInt(cell.colSpan) || 1);
          }, 0) || 3;


          for (let i = 0; i < numCols; i++) {
            const td = document.createElement('td');

            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'table-cell-wrapper';
            wrapperDiv.style.position = 'relative';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'table-cell-checkbox';
            Object.assign(checkbox.style, {
              position: 'absolute',
              top: '0px',
              right: '0px',
              width: '30px',
              height: '14px',
              zIndex: '1',
              display: 'none',
            });

            const textarea = document.createElement('textarea');
            textarea.rows = 1;
            textarea.value = '';
            Object.assign(textarea.style, {
              width: '100%',
              height: '100%',
              border: 'none', // âœ¨ bá» viá»n
              resize: 'none',
              padding: '6px',
              boxSizing: 'border-box',
              fontFamily: 'inherit',
              backgroundColor:'#ffffff',
            });
            textarea.addEventListener('input', () => autoResizeTextarea(textarea));
            requestAnimationFrame(() => autoResizeTextarea(textarea));

            wrapperDiv.appendChild(checkbox);
            wrapperDiv.appendChild(textarea);
            td.appendChild(wrapperDiv);
            newRow.appendChild(td);
          }

          table.appendChild(newRow);
        };

        // NÃºt xoÃ¡ hÃ ng cuá»‘i
      const deleteRowBtn = document.createElement('button');
      deleteRowBtn.type = 'button';
      deleteRowBtn.textContent = 'â– XoÃ¡ hÃ ng cuá»‘i';
      Object.assign(deleteRowBtn.style, {
        backgroundColor: '#ff9800',
        color: 'white',
        border: 'none',
        padding: '6px 12px',
        borderRadius: '5px',
        cursor: 'pointer',
        fontWeight: '600',
      });
      deleteRowBtn.onmouseenter = () => (deleteRowBtn.style.backgroundColor = '#e68a00');
      deleteRowBtn.onmouseleave = () => (deleteRowBtn.style.backgroundColor = '#ff9800');
      deleteRowBtn.onclick = () => {
        if (table.rows.length > 0) {
          table.deleteRow(table.rows.length - 1);
        }
      };

    
  
     const tableFooter = document.createElement('div');
      Object.assign(tableFooter.style, {
        display: 'flex',
        justifyContent: 'space-between', // cÄƒn 2 Ä‘áº§u trÃ¡i pháº£i
        marginTop: '10px',
      });

      // Container bÃªn trÃ¡i (chá»©a nÃºt XoÃ¡ báº£ng)
      const rightContainer = document.createElement('div');
      rightContainer.appendChild(deleteTableBtn);
      

      // Container bÃªn pháº£i (chá»©a 3 nÃºt cÃ²n láº¡i)
      const leftContainer = document.createElement('div');
      leftContainer.style.display = 'flex';
      leftContainer.style.gap = '10px'; // khoáº£ng cÃ¡ch giá»¯a cÃ¡c nÃºt
      leftContainer.appendChild(pasteBtn);
      leftContainer.appendChild(addRowBtn);
      leftContainer.appendChild(deleteRowBtn);

      // Gáº¯n 2 container vÃ o footer
      tableFooter.appendChild(leftContainer);
      tableFooter.appendChild(rightContainer);


      

      wrapper.appendChild(title);
      wrapper.appendChild(table);
      wrapper.appendChild(tableFooter);
      makeColumnsResizable(table);

      container.appendChild(wrapper);
    }
  });
}

window.addEventListener('DOMContentLoaded', () => {
  loadReportDataFromTemplate();
});


// Gá»­i dá»¯ liá»‡u
    document.getElementById('createReportForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const form = e.target;
      const data = {
        reportName: form.reportName.value,
        number: form.number.value,
        recipient: form.recipient.value,
        createdAt: form.createdAt.value,
        username: window.user.name,
        receivers: form.receivers.value,
        signer: form.signer.value,
        position: form.position.value,
        sections: {}
      };

      const sectionKeys = ['bscKpi', 'tuh', 'ptm', 'cntt', 'vhm', 'khcp', 'conclusion', 'kientnghi_ldtt', 'kientnghi_dvkhac', 'kehoach_tuh', 'kehoach_ptm', 'kehoach_cntt', 'kehoach_vhm', 'kehoach_khcp'];

      sectionKeys.forEach(section => {
        data.sections[section] = collectSectionData(section);
      });

      console.log('Dá»¯ liá»‡u :', data);

      fetch('/report/pvt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      }).then(res => res.json())
        .then(result => {
          if (result.success) {
            showAlert('LÆ°u bÃ¡o cÃ¡o thÃ nh cÃ´ng!','success');
            setTimeout(() => window.location.href = '/report/pvt/view', 1000);
          }
          else showAlert('Lá»—i lÆ°u bÃ¡o cÃ¡o','error');
        }).catch(() => showAlert('Lá»—i káº¿t ná»‘i server','error'));
    });


</script>
